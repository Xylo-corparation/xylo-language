/*
Phoenix Developer License (PDL), Version 1.0
Copyright Max-Dil, 2025
Software Usage Terms
This license governs your use of the software, its source code, components, and related materials (hereinafter referred to as the "Software").
By accepting the terms of this license, you agree to comply with its provisions.
By editing the source code, you automatically accept the license.
1. Grant of Rights
The Licensor grants you a non-exclusive, non-transferable, limited right to:
Use the Software on any number of devices.
Modify the source code for personal purposes or internal use.
2. Restrictions
You are prohibited from:
Distributing, publishing, or transferring the source code of the Software or its modified versions to third parties without written permission from the Licensor.
Using the Software for purposes that violate the laws of your jurisdiction.
Removing, obscuring, or altering copyright notices or license terms from the source code.
3. Disclaimer of Warranties and Liability
The Software is provided "as is," without any warranties, express or implied.
The Licensor shall not be held liable for any direct, indirect, incidental, consequential damages, loss of profits, or other losses arising from the use or inability to use the Software.
4. Copyright and Modification
All rights to the source code, structure, logic, and documentation belong to the Licensor.
Any modifications to the Software are considered derivative works. Their distribution requires written consent from the Licensor.
5. Termination
This license automatically terminates if you breach its terms. In such cases, you must destroy all copies of the Software.
6. Governing Law
This license is governed by the laws of the Russian Federation. Disputes shall be resolved in the courts of the respective jurisdiction.
*/

function getLineAndColumn(e,t){let n=1,r=1;for(let a=0;a<t;a++)"\n"===e[a]?(n++,r=1):r++;return{line:n,column:r}}function tokenize(e,t){const n=[],r=/([a-zA-Z_\u0410-\u044F][a-zA-Z0-9_\u0410-\u044F]*)|((==|\+\+|!=|<=|>=|&&|\.\.\.|\|\||\.\.|~=|=|\{|\}|[()]|,|:|;|\[|\]|<|>|\+|-|\*|\/|%|\^|\.|end|then|if|else|true|false|nil|require|and|or|not|local|global|break|class|extends|static|private|public|init|number|string|boolean|function|table|null|undefined))|(\d+\.?\d*)|('[^']*')|("[\s\S]*?")|(\/\/.*)|(--.*)|(\|)/gy;let a=0;for(;a<e.length;){if("--"===e.slice(a,a+2)||"//"===e.slice(a,a+2)){a=e.indexOf("\n",a),-1===a?a=e.length:a++;continue}r.lastIndex=a;const o=r.exec(e);if(!o||o&&";"===o[0]){a++;continue}const l=o.index,i=o[0],{line:s,column:c}=getLineAndColumn(e,l);let u=i;i.startsWith("'")&&i.endsWith("'")&&(u=`"${i.slice(1,-1)}"`),n.push({value:u,line:s,column:c,fileName:t}),a=r.lastIndex}return n}function parse(e){let t=0;function peek(){return e[t]||null}function advance(){return e[t++]}function parseTypeAnnotation(e=!1){if(peek()&&":"===peek().value){advance();const t=[];for(;peek()&&["number","string","boolean","function","table","null","undefined"].includes(peek().value);)t.push(advance()),peek()&&"|"===peek().value&&advance();if(0===t.length&&!e)throw console.error(`Expected type after ':' at line ${peek()?.line}, column ${peek()?.column}, fileName ${peek()?.fileName}`),new Error("Stop program.");return t.map((e=>e.value))}return null}function getPrecedence(e){switch(e){case"unary-":case"not":return 7;case"^":case"*":case"/":case"%":return 5;case"+":case"-":return 4;case"..":case"<":case">":case"<=":case">=":case"==":case"~=":case"!=":case"in":return 3;case"&&":case"and":return 2;case"||":case"or":return 1;default:return 0}}function parseExpression(){return function parseBinaryExpression(e){let t=parsePrimaryExpression();const n=[];for(;peek();){const r=peek(),a=getPrecedence(r.value);if(!a||a<=e)break;advance(),n.push({left:t,operator:r.value,line:r.line,column:r.column,fileName:r.fileName}),t=parsePrimaryExpression()}for(;n.length;){const{left:e,operator:r,line:a,column:o,fileName:l}=n.pop();t={type:"BinaryExpression",operator:r,left:e,right:t,line:a,column:o,fileName:l}}return t}(0)}function parsePrimaryExpression(){let n=advance();if(!n)return null;if("("===n.value){const n=parseExpression();let r=advance();if(r||(r=e[t-1]?e[t-1]:e[e.length-1]),!r||")"!==r.value)throw console.error(`Expected ')' at line ${r?.line}, column ${r?.column}, fileName: ${r?.fileName}`),new Error("Stop program.");return n}if("local"===n.value)return function parseLocalStatement(e){const t=advance();if(!/^[\p{L}_][\p{L}\p{N}_]*$/u.test(t.value))throw console.error(`Expected identifier at line ${t.line}, column ${t.column}, fileName ${t.fileName}`),new Error("Stop program.");const n=parseTypeAnnotation();let r=null;peek()&&"="===peek().value&&(advance(),r=parseExpression());return{type:"LocalDeclaration",identifier:{type:"Identifier",value:t.value,line:t.line,column:t.column,fileName:t.fileName},value:r,typeAnnotation:n,line:e.line,column:e.column,fileName:e.fileName}}(n);if("global"===n.value)return function parseGlobalStatement(e){const t=advance();if(!/^[\p{L}_][\p{L}\p{N}_]*$/u.test(t.value))throw console.error(`Expected identifier at line ${t.line}, column ${t.column}, fileName ${t.fileName}`),new Error("Stop program.");const n=parseTypeAnnotation();let r=null;peek()&&"="===peek().value&&(advance(),r=parseExpression());return{type:"GlobalDeclaration",identifier:{type:"Identifier",value:t.value,line:t.line,column:t.column,fileName:t.fileName},value:r,typeAnnotation:n,line:e.line,column:e.column,fileName:e.fileName}}(n);if("-"===n.value)return{type:"UnaryExpression",operator:"unary-",argument:parsePrimaryExpression(),line:n.line,column:n.column,fileName:n.fileName};if("not"===n.value)return{type:"UnaryExpression",operator:"not",argument:parseExpression(),line:n.line,column:n.column,fileName:n.fileName};switch(n.value){case"require":return function parseRequireStatement(e){const t=advance();if("("!==t.value)throw console.error(`Expected '(' at line ${t.line}, column ${t.column}, fileName ${t.fileName}`),new Error("Stop program.");const n=advance();if(!n.value.startsWith('"'))throw console.error(`Expected string literal at line ${n.line}, column ${n.column}, fileName ${n.fileName}`),new Error("Stop program.");const r=advance();if(")"!==r.value)throw console.error(`Expected ')' at line ${r.line}, column ${r.column}, fileName ${r.fileName}`),new Error("Stop program.");return{type:"RequireStatement",moduleName:n.value.slice(1,-1),line:e.line,column:e.column,fileName:e.fileName}}(n);case"function":case"fun":return parseFunctionDefinition(n);case"while":return function parseWhileLoop(n){const r=parseExpression();let a=advance();a||(a=e[t-1]?e[t-1]:e[e.length-1]);if("do"!==a.value)throw console.error(`Expected 'do' at line ${a.line}, column ${a.column}, fileName ${a.fileName}`),new Error("Stop program.");const o=[];for(;peek()&&"end"!==peek().value;)o.push(parseExpression());let l=advance();l||(l=e[t-1]?e[t-1]:e[e.length-1]);if("end"!==l.value)throw console.error(`Expected 'end' at line ${l.line}, column ${l.column}, fileName ${l.fileName}`),new Error("Stop program.");return{type:"WhileStatement",condition:r,body:o,line:n.line,column:n.column,fileName:n.fileName}}(n);case"for":return function parseForLoop(n){let r=advance();r||(r=e[t-1]?e[t-1]:e[e.length-1]);if(!/^[\p{L}_][\p{L}\p{N}_]*$/u.test(r.value))throw console.error(`Expected variable name after 'for' at line ${r.line}, column ${r.column}, fileName ${r.fileName}`),new Error("Stop program.");let a=peek();if(a&&"="===a.value){advance();const a=parseExpression();let o=advance();if(o||(o=e[t-1]?e[t-1]:e[e.length-1]),","!==o.value)throw console.error(`Expected ',' after start value in for loop at line ${o.line}, column ${o.column}, fileName ${o.fileName}`),new Error("Stop program.");const l=parseExpression();let i={type:"Number",value:1,line:n.line,column:n.column,fileName:n.fileName};peek()&&","===peek().value&&(advance(),i=parseExpression());let s=advance();if(s||(s=e[t-1]?e[t-1]:e[e.length-1]),"do"!==s.value)throw console.error(`Expected 'do' after for loop parameters at line ${s.line}, column ${s.column}, fileName ${s.fileName}`),new Error("Stop program.");const c=[];for(;peek()&&"end"!==peek().value;)c.push(parseExpression());let u=advance();if(u||(u=e[t-1]?e[t-1]:e[e.length-1]),"end"!==u.value)throw console.error(`Expected 'end' after for loop body at line ${u.line}, column ${u.column}, fileName ${u.fileName}`),new Error("Stop program.");return{type:"ForStatement",variable:{type:"Identifier",value:r.value,line:r.line,column:r.column,fileName:r.fileName},start:a,end:l,step:i,body:c,line:n.line,column:n.column,fileName:n.fileName}}{let a=advance();if(a||(a=e[t-1]?e[t-1]:e[e.length-1]),","!==a.value)throw console.error(`Expected ',' after variable name in for loop at line ${a.line}, column ${a.column}, fileName ${r.fileName}`),new Error("Stop program.");let o=advance();if(o||(o=e[t-1]?e[t-1]:e[e.length-1]),!/[a-zA-Z_][a-zA-Z0-9_]*/.test(o.value))throw console.error(`Expected variable name after ',' at line ${o.line}, column ${o.column}, fileName ${o.fileName}`),new Error("Stop program.");let l=advance();if(l||(l=e[t-1]?e[t-1]:e[e.length-1]),"in"!==l.value)throw console.error(`Expected 'in' after variable name in for loop at line ${l.line}, column ${l.column}, fileName ${l.fileName}`),new Error("Stop program.");const i=parseExpression();if("FunctionCall"!==i.type)throw console.error(`Expected function call after 'in' in for loop at line ${i.line}, column ${i.column}, fileName ${i.fileName}`),new Error("Stop program.");let s=advance();if(s||(s=e[t-1]?e[t-1]:e[e.length-1]),"do"!==s.value)throw console.error(`Expected 'do' after for loop parameters at line ${s.line}, column ${s.column}, fileName ${s.fileName}`),new Error("Stop program.");const c=[];for(;peek()&&"end"!==peek().value;)c.push(parseExpression());let u=advance();if(u||(u=e[t-1]?e[t-1]:e[e.length-1]),"end"!==u.value)throw console.error(`Expected 'end' after for loop body at line ${u.line}, column ${u.column}, fileName ${u.fileName}`),new Error("Stop program.");return{type:"ForInStatement",keyVariable:{type:"Identifier",value:r.value,line:r.line,column:r.column,fileName:r.fileName},valueVariable:{type:"Identifier",value:o.value,line:o.line,column:o.column,fileName:o.fileName},iteratorCall:i,body:c,line:n.line,column:n.column,fileName:n.fileName}}}(n);case"if":return function parseIfStatement(n){const r=parseExpression();let a=advance();a||(a=e[t-1]?e[t-1]:e[e.length-1]);if("then"!==a.value)throw console.error(`Expected 'then' after 'if' condition at line ${a.line}, column ${a.column}, fileName ${a.fileName}`),new Error("Stop program.");const o=[];for(;peek()&&"else"!==peek().value&&"end"!==peek().value;)o.push(parseExpression());let l=[];if(peek()&&"else"===peek().value)for(advance();peek()&&"end"!==peek().value;)l.push(parseExpression());let i=advance();i||(i=e[t-1]?e[t-1]:e[e.length-1]);if("end"!==i.value)throw console.error(`Expected 'end' after 'if' statement at line ${i.line}, column ${i.column}, fileName ${i.fileName}`),new Error("Stop program.");return{type:"IfStatement",condition:r,thenBody:o,elseBody:l,line:n.line,column:n.column,fileName:n.fileName}}(n);case"class":return function parseClassDefinition(n){const r=advance();if(!/^[\p{L}_][\p{L}\p{N}_]*$/u.test(r.value))throw console.error(`Expected class name at line ${r.line}, column ${r.column}, fileName ${r.fileName}`),new Error("Stop program.");let a=null;if(peek()&&"extends"===peek().value){advance();const e=advance();if(!/^[\p{L}_][\p{L}\p{N}_]*$/u.test(e.value))throw console.error(`Expected parent class name at line ${e.line}, column ${e.column}, fileName ${e.fileName}`),new Error("Stop program.");a={type:"Identifier",value:e.value,line:e.line,column:e.column,fileName:e.fileName}}const o=[],l=[],i=[],s=[];for(;peek()&&"end"!==peek().value;){const e=peek();let t=!1,n=!1;"static"===e.value?(t=!0,advance()):"private"===e.value?(n=!0,advance()):"public"===e.value&&advance();const r=peek();if("function"===r.value||"fun"===r.value){const e=parseFunctionDefinition(advance());t?s.push(e):(e.isPrivate=n,l.push(e))}else{const e=advance();if(!/^[\p{L}_][\p{L}\p{N}_]*$/u.test(e.value))throw console.error(`Expected field name at line ${e.line}, column ${e.column}, fileName ${e.fileName}`),new Error("Stop program.");let r=null;peek()&&"="===peek().value&&(advance(),r=parseExpression());const a={type:"FieldDeclaration",name:e.value,value:r,isPrivate:n,line:e.line,column:e.column,fileName:e.fileName};t?i.push(a):o.push(a)}}let c=advance();c||(c=e[t-1]?e[t-1]:e[e.length-1]);if(!c||"end"!==c.value)throw console.error(`Expected 'end' at line ${c?.line}, column ${c?.column}, fileName ${c?.fileName}`),new Error("Stop program.");return{type:"ClassDefinition",name:r.value,parent:a,fields:o,methods:l,staticFields:i,staticMethods:s,line:n.line,column:n.column,fileName:n.fileName}}(n);case"break":return{type:"BreakStatement",line:n.line,column:n.column,fileName:n.fileName};case"true":return{type:"Boolean",value:!0,line:n.line,column:n.column,fileName:n.fileName};case"false":return{type:"Boolean",value:!1,line:n.line,column:n.column,fileName:n.fileName};case"nil":return{type:"Nil",value:null,line:n.line,column:n.column,fileName:n.fileName};case"switch":return function parseSwitchStatement(n){const r=parseExpression(),a=[];let o=null;for(;peek()&&"end"!==peek().value;){const e=peek();if("case"===e.value){advance();const t=parseExpression(),n=advance();if(":"!==n.value)throw console.error(`Expected ':' after case value at line ${n.line}, column ${n.column}, fileName ${n.fileName}`),new Error("Stop program.");const r=[];for(;peek()&&"case"!==peek().value&&"default"!==peek().value&&"end"!==peek().value;)r.push(parseExpression());a.push({test:t,body:r,line:e.line,column:e.column,fileName:e.fileName})}else if("default"===e.value){advance();const t=advance();if(":"!==t.value)throw console.error(`Expected ':' after default at line ${t.line}, column ${t.column}, fileName ${t.fileName}`),new Error("Stop program.");const n=[];for(;peek()&&"case"!==peek().value&&"default"!==peek().value&&"end"!==peek().value;)n.push(parseExpression());o={body:n,line:e.line,column:e.column,fileName:e.fileName}}else console.error(`Expected 'case', 'default', or 'end' at line ${e.line}, column ${e.column}, fileName ${e.fileName}`),advance()}let l=advance();l||(l=e[t-1]?e[t-1]:e[e.length-1]);if("end"!==l.value)throw console.error(`Expected 'end' after switch statement at line ${l.line}, column ${l.column}, fileName ${l.fileName}`),new Error("Stop program.");return{type:"SwitchStatement",discriminant:r,cases:a,defaultCase:o,line:n.line,column:n.column,fileName:n.fileName}}(n);case"try":return function parseTryStatement(n){const r=[];for(;peek()&&"catch"!==peek().value&&"end"!==peek().value;)r.push(parseExpression());let a=null;if(peek()&&"catch"===peek().value){advance();const e=advance();if(!/^[\p{L}_][\p{L}\p{N}_]*$/u.test(e.value))throw console.error(`Expected identifier after 'catch' at line ${e.line}, column ${e.column}, fileName ${e.fileName}`),new Error("Stop program.");const t=[];for(;peek()&&"end"!==peek().value;)t.push(parseExpression());a={param:{type:"Identifier",value:e.value,line:e.line,column:e.column,fileName:e.fileName},body:t}}let o=advance();o||(o=e[t-1]?e[t-1]:e[e.length-1]);if("end"!==o.value)throw console.error(`Expected 'end' after try statement at line ${o.line}, column ${o.column}, fileName ${o.fileName}`),new Error("Stop program.");return{type:"TryStatement",block:r,handler:a,line:n.line,column:n.column,fileName:n.fileName}}(n);case"return":return function parseReturnStatement(e){return{type:"ReturnStatement",argument:parseExpression(),line:e.line,column:e.column,fileName:e.fileName}}(n);case"...":return{type:"VarargExpression",line:n.line,column:n.column,fileName:n.fileName}}if(n.value.startsWith('"')&&n.value.endsWith('"'))return{type:"String",value:n.value.slice(1,-1),line:n.line,column:n.column,fileName:n.fileName};if(/^\d+\.?\d*$/.test(n.value))return{type:"Number",value:Number(n.value),line:n.line,column:n.column,fileName:n.fileName};if(/^[\p{L}_][\p{L}\p{N}_]*$/u.test(n.value)){let e={type:"Identifier",value:n.value,line:n.line,column:n.column,fileName:n.fileName},r=null;if(peek()&&":"===peek().value){const e=t;r=parseTypeAnnotation(!0),0===r.length&&(t=e)}for(;peek()&&("."===peek().value||":"===peek().value||"["===peek().value||"("===peek().value);){const t=peek();if("["===t.value){advance();const n=parseExpression(),r=advance();if("]"!==r.value)throw console.error(`Expected ']' at line ${r.line}, column ${r.column}, fileName ${r.fileName}`),new Error("Stop program.");e={type:"MemberExpression",object:e,property:n,computed:!0,line:t.line,column:t.column,fileName:t.fileName}}else if("."===t.value){advance();const n=advance();if(!/^[\p{L}_][\p{L}\p{N}_]*$/u.test(n.value))throw console.error(`Invalid identifier at line ${n.line}, column ${n.column}, fileName ${n.fileName}`),new Error("Stop program.");e={type:"MemberExpression",object:e,property:{type:"Identifier",value:n.value,line:n.line,column:n.column,fileName:n.fileName},computed:!1,line:t.line,column:t.column,fileName:t.fileName}}else if(":"===t.value){advance();const n=advance();if(!/^[\p{L}_][\p{L}\p{N}_]*$/u.test(n.value))throw console.error(`Invalid method name at line ${n.line}, column ${n.column}, fileName ${n.fileName}`),new Error("Stop program.");e={type:"MemberExpression",object:e,property:{type:"Identifier",value:n.value,line:n.line,column:n.column,fileName:n.fileName},computed:!1,line:t.line,column:t.column,fileName:t.fileName},peek()&&"("===peek().value&&(e=parseMethodCallWithColon(e))}else"("===t.value&&(e=parseFunctionCall(e))}if(peek()&&"++"===peek().value)return advance(),{type:"UpdateExpression",operator:"++",argument:e,prefix:!1,line:n.line,column:n.column,fileName:n.fileName};if(peek()&&":"===peek().value){advance();const t=advance();if(peek()&&"("===peek().value)return e={type:"MemberExpression",object:e,property:{type:"Identifier",value:t.value,line:t.line,column:t.column,fileName:t.fileName},computed:!1,line:n.line,column:n.column,fileName:n.fileName},{type:"FunctionMethodCall",callee:e,arguments:parseArguments(),line:n.line,column:n.column,fileName:n.fileName}}if(peek()&&"="===peek().value){advance();return{type:"AssignmentExpression",target:e,value:parseExpression(),typeAnnotation:r||undefined,line:n.line,column:n.column,fileName:n.fileName}}return e}if("{"===n.value)return function parseTable(n){const r={type:"Table",properties:[],typeAnnotation:parseTypeAnnotation(),line:n.line,column:n.column,fileName:n.fileName};let a=0,o=!1;for(;peek()&&"}"!==peek().value;){let n;if("["===peek().value){advance(),n=parseExpression();const e=advance();if("]"!==e.value)throw console.error(`Expected ']' at line ${e.line}, column ${e.column}, fileName ${e.fileName}`),new Error("Stop program.");o=!0}else if(/^[\p{L}_][\p{L}\p{N}_]*$/u.test(peek().value)&&"="===e[t+1]?.value)n={type:"String",value:advance().value,line:peek()?.line,column:peek()?.column,fileName:peek()?.fileName},o=!0;else{if(o)throw console.error(`Expected key definition at line ${peek()?.line}, column ${peek()?.column}, fileName ${peek()?.fileName}`),new Error("Stop program.");n={type:"Number",value:a++,line:peek()?.line,column:peek()?.column,fileName:peek()?.fileName}}if(peek()&&"="===peek().value)advance();else if(o)throw console.error(`Expected '=' after key at line ${peek()?.line}, column ${peek()?.column}, fileName ${peek()?.fileName}`),new Error("Stop program.");const l=parseExpression();if(r.properties.push({key:n,value:l,line:n.line,column:n.column,fileName:n.fileName}),","===peek()?.value)advance();else if("}"!==peek()?.value)throw console.error(`Expected ',' or '}' at line ${peek()?.line}, column ${peek()?.column}, fileName ${peek()?.fileName}`),new Error("Stop program.")}const l=advance();if(!l||"}"!==l.value)throw console.error(`Expected '}' at line ${l?.line}, column ${l?.column}, fileName ${l?.fileName}`),new Error("Stop program.");return r}(n);throw console.error(`Unexpected token '${n.value}' at line ${n.line}, column ${n.column}, fileName ${n.fileName}`),new Error("Stop program.")}function parseMethodCallWithColon(n){advance();const r=[];for(;peek()&&")"!==peek().value;)r.push(parseExpression()),peek()&&","===peek().value&&advance();let a=advance();if(a||(a=e[t-1]?e[t-1]:e[e.length-1]),!a||")"!==a.value)throw console.error(`Expected ')' at line ${a.line}, column ${a.column}, fileName ${a.fileName}`),new Error("Stop program.");const o=n.object;r.unshift(o);let l={type:"FunctionMethodCall",callee:n,arguments:r,line:n.line,column:n.column,fileName:n.fileName};for(;peek()&&("."===peek().value||":"===peek().value||"["===peek().value||"("===peek().value);){const e=advance();if("["===e.value){const t=parseExpression(),n=advance();if("]"!==n.value)throw console.error(`Expected ']' at line ${n.line}, column ${n.column}, fileName ${n.fileName}`),new Error("Stop program.");l={type:"MemberExpression",object:l,property:t,computed:!0,line:e.line,column:e.column,fileName:e.fileName}}else if("."===e.value){const t=advance();if(!/^[\p{L}_][\p{L}\p{N}_]*$/u.test(t.value))throw console.error(`Invalid identifier at line ${t.line}, column ${t.column}, fileName ${t.fileName}`),new Error("Stop program.");l={type:"MemberExpression",object:l,property:{type:"Identifier",value:t.value,line:t.line,column:t.column,fileName:t.fileName},computed:!1,line:e.line,column:e.column,fileName:e.fileName}}else if(":"===e.value){const t=advance();if(!/^[\p{L}_][\p{L}\p{N}_]*$/u.test(t.value))throw console.error(`Invalid method name at line ${t.line}, column ${t.column}, fileName ${t.fileName}`),new Error("Stop program.");l={type:"MemberExpression",object:l,property:{type:"Identifier",value:t.value,line:t.line,column:t.column,fileName:t.fileName},computed:!1,line:e.line,column:e.column,fileName:e.fileName},peek()&&"("===peek().value&&(l=parseMethodCallWithColon(l))}else"("===e.value&&(l=parseFunctionCall(l))}return l}function parseFunctionDefinition(n){let r=`anon_${Math.random().toString(36).substr(2,8)}`,a=!1,o=!1;peek()&&"*"===peek().value&&(o=!0,advance());let l=peek();if(l&&/^[\p{L}_][\p{L}\p{N}_]*$/u.test(l.value)&&(r=advance().value,l=peek()),l&&":"===l.value){a=!0,advance();r=advance().value,l=peek()}if(l||(l=e[t-1]||e[e.length-1]),"("!==l.value)throw console.error(`Expected '(' at line ${l.line}, column ${l.column}`),new Error("Stop program.");advance();const i=[];let s=!1;for(;peek()&&")"!==peek().value;){const e=advance();if("..."===e.value){s=!0,i.push({type:"Vararg",value:"...",line:e.line,column:e.column,fileName:e.fileName});break}const t=parseTypeAnnotation();i.push({type:"Identifier",value:e.value,typeAnnotation:t,line:e.line,column:e.column,fileName:e.fileName}),peek()&&","===peek().value&&advance()}let c=advance();if(c||(c=e[t-1]?e[t-1]:e[e.length-1]),")"!==c.value)throw console.error(`Expected ')' at line ${c.line}, column ${c.column}`),new Error("Stop program.");const u=parseTypeAnnotation(),p=[];for(;peek()&&"end"!==peek().value;)p.push(parseExpression());let m=advance();if(m||(m=e[t-1]?e[t-1]:e[e.length-1]),"end"!==m.value)throw console.error(`Expected 'end' at line ${m.line}, column ${m.column}`),new Error("Stop program.");return{type:a?"FunctionMethodDefinition":"FunctionDefinition",name:r,isAsync:o,params:i,hasVararg:s,returnType:u,body:p,line:n.line,column:n.column,fileName:n.fileName}}function parseFunctionCall(n){advance();const r=[];for(;peek()&&")"!==peek().value;)r.push(parseExpression()),peek()&&","===peek().value&&advance();let a=advance();if(a||(a=e[t-1]?e[t-1]:e[e.length-1]),!a||")"!==a.value)throw console.error(`Expected ')' at line ${a.line}, column ${a.column}, fileName ${a.fileName}`),new Error("Stop program.");let o={type:"Identifier"===n.type&&/^[A-Z]/.test(n.value)?"ClassInstantiation":"FunctionCall",callee:n,arguments:r,line:n.line,column:n.column,fileName:n.fileName};for(;peek()&&("."===peek().value||":"===peek().value||"["===peek().value||"("===peek().value);){const e=advance();if("["===e.value){const t=parseExpression(),n=advance();if("]"!==n.value)throw console.error(`Expected ']' at line ${n.line}, column ${n.column}, fileName ${n.fileName}`),new Error("Stop program.");o={type:"MemberExpression",object:o,property:t,computed:!0,line:e.line,column:e.column,fileName:e.fileName}}else if("."===e.value){const t=advance();if(!/^[\p{L}_][\p{L}\p{N}_]*$/u.test(t.value))throw console.error(`Invalid identifier at line ${t.line}, column ${t.column}, fileName ${t.fileName}`),new Error("Stop program.");o={type:"MemberExpression",object:o,property:{type:"Identifier",value:t.value,line:t.line,column:t.column,fileName:t.fileName},computed:!1,line:e.line,column:e.column,fileName:e.fileName}}else if(":"===e.value){const t=advance();if(!/^[\p{L}_][\p{L}\p{N}_]*$/u.test(t.value))throw console.error(`Invalid method name at line ${t.line}, column ${t.column}, fileName ${t.fileName}`),new Error("Stop program.");o={type:"MemberExpression",object:o,property:{type:"Identifier",value:t.value,line:t.line,column:t.column,fileName:t.fileName},computed:!1,line:e.line,column:e.column,fileName:e.fileName},peek()&&"("===peek().value&&(o=parseMethodCallWithColon(o))}else"("===e.value&&(o=parseFunctionCall(o))}return o}function parseArguments(){advance();const e=[];for(;peek()&&")"!==peek().value;)e.push(parseExpression()),peek()&&","===peek().value&&advance();const t=advance();if(")"!==t.value)throw console.error(`Expected ')' at line ${t.line}, column ${t.column}`),new Error("Stop program.");return e}const n=[];for(;t<e.length;){const e=parseExpression();e&&"End"!==e.type&&n.push(e)}return n}const createDom=function(){return{get:(e,t=document)=>t.querySelector(e),getAll:(e,t=document)=>Array.from(t.querySelectorAll(e)),byId:e=>document.getElementById(e),create:async(e,t={})=>{const n=document.createElement(e);return t.attrs&&Object.entries(t.attrs).forEach((([e,t])=>{n.setAttribute(e,t)})),t.text&&(n.textContent=t.text),t.html&&(n.innerHTML=t.html),t.listeners&&Object.entries(t.listeners).forEach((([e,t])=>{n.addEventListener(e,t)})),n},append:async(e,...t)=>(t.forEach((t=>e.appendChild(t))),e),remove:e=>e.parentNode.removeChild(e),addClass:async(e,...t)=>(e.classList.add(...t.flatMap((e=>e.split(" ")))),e),removeClass:async(e,...t)=>(e.classList.remove(...t.flatMap((e=>e.split(" ")))),e),css:async(e,t)=>"string"==typeof t?e.style[t]:(Object.assign(e.style,t),e),on:async(e,t,n,r)=>{const callback=e=>n(e.detail||e);return e.addEventListener(t,callback,r),()=>e.removeEventListener(t,callback,r)},val:async(e,t)=>void 0!==t?(e.value=t,e):e.value,animate:async(e,t,n)=>{const r=e.animate(t,n);return{finished:r.finished,cancel:()=>r.cancel()}},show:async e=>{const t=e.dataset.originalDisplay||"block";return e.style.display=t,e},hide:async e=>("none"!==e.style.display&&(e.dataset.originalDisplay=getComputedStyle(e).display),e.style.display="none",e),fetch:async(e,t={})=>{try{const n=await window.fetch(e,t);return{ok:n.ok,status:n.status,json:async()=>await n.json(),text:async()=>await n.text(),blob:async()=>await n.blob()}}catch(error){return{ok:!1,error:error.message}}},trigger:async(e,t,n=null)=>{const r=new CustomEvent(t,{detail:n});return e.dispatchEvent(r),e},data:async(e,t,n)=>void 0!==n?(e.dataset[t]=n,e):e.dataset[t],delegate:async(e,t,n,r)=>{const callback=t=>{const a=t.target.closest(n);a&&e.contains(a)&&r.call(a,t)};return e.addEventListener(t,callback),()=>e.removeEventListener(t,callback)},isVisible:async e=>e.offsetWidth>0||e.offsetHeight>0||e.getClientRects().length>0,serialize:async e=>Object.fromEntries(new FormData(e).entries()),prepend:async(e,...t)=>(t.reverse().forEach((t=>e.prepend(t))),e),before:async(e,...t)=>(t.forEach((t=>e.before(t))),e),after:async(e,...t)=>(t.forEach((t=>e.after(t))),e),toggleClass:async(e,t)=>(e.classList.toggle(t),e),hasClass:async(e,t)=>e.classList.contains(t),attr:async(e,t,n)=>void 0!==n?(e.setAttribute(t,n),e):e.getAttribute(t),replace:async(e,t)=>(e.replaceWith(t),t),clone:async(e,t=!0)=>e.cloneNode(t),children:async e=>Array.from(e.children),parent:async e=>e.parentElement,siblings:async e=>Array.from(e.parentElement.children).filter((t=>t!==e)),closest:async(e,t)=>e.closest(t),matches:async(e,t)=>e.matches(t),toggle:async e=>"none"===e.style.display?dom.show(e):dom.hide(e),scrollTo:async(e,t={})=>(e.scrollIntoView(t),e),getStyle:async(e,t)=>getComputedStyle(e)[t],debug:async e=>{const t={tag:e.tagName,id:e.id||null,classes:Array.from(e.classList),attributes:Object.fromEntries([...e.attributes].map((e=>[e.name,e.value]))),rect:e.getBoundingClientRect(),computedStyles:getComputedStyle(e)};return console.log("DOM Element Debug:",t),e},batchUpdate:async(e,t)=>{const n=document.createDocumentFragment();return t.forEach((e=>{const t=e.element||dom.create(e.tag,e.options);n.appendChild(t)})),e.appendChild(n),e},observe:async(e,t,n={attributes:!0,childList:!0,subtree:!0})=>{const r=new MutationObserver((e=>t(e)));return r.observe(e,n),()=>r.disconnect()},loadScript:async(e,t={})=>{const n=await dom.create("script",{attrs:{src:e,...t.attrs},listeners:{load:t.onload,error:t.onerror}});return document.head.appendChild(n),n},loadStyle:async(e,t={})=>{const n=await dom.create("link",{attrs:{rel:"stylesheet",href:e,...t.attrs}});return document.head.appendChild(n),n},findByText:async(e,t=document)=>{const n=new RegExp(e,"i");return dom.getAll("*",t).filter((e=>n.test(e.textContent)))},disable:async e=>(e.setAttribute("disabled","true"),e),enable:async e=>(e.removeAttribute("disabled"),e),setFocus:async e=>(e.focus(),e),clear:async e=>(e.innerHTML="",e)}},error=e=>{throw new Error(e)},tonumber=(e,t=0)=>{const n=Number(e);return isNaN(n)?t:n},type=e=>{if(null===e)return"null";if(e===undefined)return"undefined";const t=typeof e;return"number"===t?"number":"string"===t?"string":"boolean"===t?"boolean":"function"===t?"function":"object"===t?"table":t},createIterator=function(e){let t=e();return{next:()=>{if(null===t)return{done:!0};const n=t;return t=e(),{value:n,done:!1}},[Symbol.iterator]:function(){return this}}},createJson=function(){return{encode:function encode(e){try{return JSON.stringify(e)}catch(t){if(t instanceof TypeError&&t.message.startsWith("cyclic object value"))throw new TypeError("JSONLib.encode: Unexpected cyclic reference detected after deep copy.  This is a bug in deepCopy().");throw t}},decode:function decode(e){try{return JSON.parse(e)}catch(t){throw new SyntaxError("JSONLib.decode: Недопустимый JSON: "+t.message)}},isValid:function isValid(e){try{return JSON.parse(e),!0}catch(t){return!1}},pretty:function pretty(e,t=2){try{const n=JSON.parse(e);return JSON.stringify(n,null,t)}catch(n){return e}},get:function get(e,t,n=undefined){if("object"!=typeof e||null===e)return n;const r=t.split(".");let a=e;for(const o of r){if("object"!=typeof a||null===a||!(o in a))return n;a=a[o]}return a}}},createMath=function(){class Vector{constructor(...e){this.components=e}add(e){return this._checkLength(e),new Vector(...this.components.map(((t,n)=>t+e.components[n])))}subtract(e){return this._checkLength(e),new Vector(...this.components.map(((t,n)=>t-e.components[n])))}scale(e){return new Vector(...this.components.map((t=>t*e)))}dot(e){return this._checkLength(e),this.components.reduce(((t,n,r)=>t+n*e.components[r]),0)}cross(e){if(3!==this.components.length||3!==e.components.length)throw new Error("Cross product is only defined for 3D vectors");const[t,n,r]=this.components,[a,o,l]=e.components;return new Vector(n*l-r*o,r*a-t*l,t*o-n*a)}magnitude(){return Math.sqrt(this.components.reduce(((e,t)=>e+t**2),0))}normalize(){const e=this.magnitude();if(0===e)throw new Error("Cannot normalize zero vector");return this.scale(1/e)}equals(e,t=1e-6){return this.components.every(((n,r)=>Math.abs(n-e.components[r])<t))}_checkLength(e){if(this.components.length!==e.components.length)throw new Error("Vectors must have same length")}toString(){return`Vector(${this.components.join(", ")})`}}class Matrix{constructor(e){if(!e.every((t=>t.length===e[0].length)))throw new Error("All rows must have same length");this.rows=e.map((e=>[...e])),this.rowsCount=e.length,this.colsCount=e[0].length}transpose(){const e=[];for(let t=0;t<this.colsCount;t++){e[t]=[];for(let n=0;n<this.rowsCount;n++)e[t][n]=this.rows[n][t]}return new Matrix(e)}multiply(e){if(this.colsCount!==e.rowsCount)throw new Error("Columns count of A must match rows count of B");const t=[];for(let n=0;n<this.rowsCount;n++){t[n]=[];for(let r=0;r<e.colsCount;r++){let a=0;for(let t=0;t<this.colsCount;t++)a+=this.rows[n][t]*e.rows[t][r];t[n][r]=a}}return new Matrix(t)}determinant(){if(!this.isSquare())throw new Error("Matrix must be square");if(1===this.rowsCount)return this.rows[0][0];if(2===this.rowsCount)return this.rows[0][0]*this.rows[1][1]-this.rows[0][1]*this.rows[1][0];let e=0;for(let t=0;t<this.colsCount;t++)e+=this.rows[0][t]*this.cofactor(0,t);return e}cofactor(e,t){return(-1)**(e+t)*this.minorMatrix(e,t).determinant()}minorMatrix(e,t){return new Matrix(this.rows.filter(((t,n)=>n!==e)).map((e=>e.filter(((e,n)=>n!==t)))))}inverse(){const e=this.determinant();if(0===e)throw new Error("Matrix is singular");const t=[];for(let n=0;n<this.rowsCount;n++){t[n]=[];for(let e=0;e<this.colsCount;e++)t[n][e]=this.cofactor(n,e)}return new Matrix(t).transpose().scale(1/e)}scale(e){return new Matrix(this.rows.map((t=>t.map((t=>t*e)))))}isSquare(){return this.rowsCount===this.colsCount}equals(e,t=1e-6){return this.rows.every(((n,r)=>n.every(((n,a)=>Math.abs(n-e.rows[r][a])<t))))}toString(){return this.rows.map((e=>e.join("\t"))).join("\n")}static identity(e){const t=[];for(let n=0;n<e;n++)t[n]=new Array(e).fill(0),t[n][n]=1;return new Matrix(t)}}const e={pi:Math.PI,huge:Infinity,vec:{create:(...e)=>new Vector(...e),add:(e,t)=>e.add(t),sub:(e,t)=>e.subtract(t),scale:(e,t)=>e.scale(t),dot:(e,t)=>e.dot(t),cross:(e,t)=>e.cross(t),mag:e=>e.magnitude(),normalize:e=>e.normalize(),dist:(e,t)=>e.subtract(t).magnitude(),angleBetween:(e,t)=>{const n=e.dot(t);return Math.acos(n/(e.magnitude()*t.magnitude()))}},mat:{create:e=>new Matrix(e),identity:e=>Matrix.identity(e),transpose:e=>e.transpose(),multiply:(e,t)=>e.multiply(t),determinant:e=>e.determinant(),inverse:e=>e.inverse(),rotation2D:e=>{const t=Math.cos(e),n=Math.sin(e);return new Matrix([[t,-n],[n,t]])},rotationX:e=>{const t=Math.cos(e),n=Math.sin(e);return new Matrix([[1,0,0],[0,t,-n],[0,n,t]])},rotationY:e=>{const t=Math.cos(e),n=Math.sin(e);return new Matrix([[t,0,n],[0,1,0],[-n,0,t]])},rotationZ:e=>{const t=Math.cos(e),n=Math.sin(e);return new Matrix([[t,-n,0],[n,t,0],[0,0,1]])}},round:Math.ceil,abs:Math.abs,acos:Math.acos,asin:Math.asin,atan:Math.atan,atan2:Math.atan2,ceil:Math.ceil,cos:Math.cos,deg:e=>180*e/Math.PI,exp:Math.exp,floor:Math.floor,fmod:(e,t)=>e-Math.floor(e/t)*t,log:(e,t)=>t?Math.log(e)/Math.log(t):Math.log(e),max:(...e)=>Math.max(...e),min:(...e)=>Math.min(...e),modf:e=>{const t=Math.trunc(e);return{__multiReturn:!0,1:t,2:e-t}},rad:e=>e*Math.PI/180,sin:Math.sin,sqrt:Math.sqrt,tan:Math.tan,frexp:e=>{if(0===e)return{__multiReturn:!0,1:0,2:0};const t=Math.floor(Math.log2(Math.abs(e)))+1;return{__multiReturn:!0,1:e*Math.pow(2,-t),2:t}},ldexp:(e,t)=>e*Math.pow(2,t),_randState:1,randomseed:t=>{e._randState=t?2147483647&t:2147483647&(new Date).getTime()},random:(...t)=>{e._randState=214013*e._randState+2531011&2147483647;const n=(e._randState>>>16)/32767;if(0===t.length)return n;if(1===t.length){const e=t[0];return Math.floor(n*e)+1}if(2===t.length){const[e,r]=t;return Math.floor(n*(r-e+1))+e}throw new Error("wrong number of arguments to 'random'")},cosh:Math.cosh||function(e){return(Math.exp(e)+Math.exp(-e))/2},sinh:Math.sinh||function(e){return(Math.exp(e)-Math.exp(-e))/2},tanh:Math.tanh||function(e){return e===Infinity?1:e===-Infinity?-1:(Math.exp(2*e)-1)/(Math.exp(2*e)+1)},log10:e=>Math.log10(e),pow:Math.pow,ult:(e,t)=>e>>>0<t>>>0,lerp:function(e,t,n){return t+e*(n-t)},clamp:(e,t,n)=>Math.min(Math.max(e,t),n),smoothstep:(t,n,r)=>(t=e.clamp((t-n)/(r-n),0,1))*t*(3-2*t),toPolar:(e,t)=>({r:Math.sqrt(e*e+t*t),theta:Math.atan2(t,e)}),fromPolar:(e,t)=>({x:e*Math.cos(t),y:e*Math.sin(t)})};return e.randomseed(),e},createNoise=()=>{const e={perm:new Array(512),grad3:[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]],F2:.5*(Math.sqrt(3)-1),G2:(3-Math.sqrt(3))/6,F3:1/3,G3:1/6,init:function(e=0){const t=new Array(256);for(let r=0;r<256;r++)t[r]=r;let n=1664525*e+1013904223>>>0;for(let r=0;r<256;r++){n=1664525*n+1013904223>>>0;const e=n%256;[t[r],t[e]]=[t[e],t[r]]}for(let r=0;r<512;r++)this.perm[r]=t[255&r]},grad:function(e,t,n,r){const a=15&e,o=a<8?t:n,l=a<4?n:12===a||14===a?t:r;return(0==(1&a)?o:-o)+(0==(2&a)?l:-l)},fade:function(e){return e*e*e*(e*(6*e-15)+10)},lerp:function(e,t,n){return e+n*(t-e)},perlin1D:function(e,t=0){this.init(t);const n=255&Math.floor(e);e-=Math.floor(e);const r=this.fade(e),a=this.perm[n],o=this.perm[n+1];return this.lerp(this.grad(a,e,0,0),this.grad(o,e-1,0,0),r)},perlin2D:function(e,t,n=0){this.init(n);const r=255&Math.floor(e),a=255&Math.floor(t);e-=Math.floor(e),t-=Math.floor(t);const o=this.fade(e),l=this.fade(t),i=this.perm[r]+a,s=this.perm[r+1]+a;return this.lerp(this.lerp(this.grad(this.perm[i],e,t,0),this.grad(this.perm[s],e-1,t,0),o),this.lerp(this.grad(this.perm[i+1],e,t-1,0),this.grad(this.perm[s+1],e-1,t-1,0),o),l)},perlin3D:function(e,t,n,r=0){this.init(r);const a=255&Math.floor(e),o=255&Math.floor(t),l=255&Math.floor(n);e-=Math.floor(e),t-=Math.floor(t),n-=Math.floor(n);const i=this.fade(e),s=this.fade(t),c=this.fade(n),u=this.perm[a]+o,p=this.perm[u]+l,m=this.perm[u+1]+l,f=this.perm[a+1]+o,h=this.perm[f]+l,d=this.perm[f+1]+l;return this.lerp(this.lerp(this.lerp(this.grad(this.perm[p],e,t,n),this.grad(this.perm[h],e-1,t,n),i),this.lerp(this.grad(this.perm[m],e,t-1,n),this.grad(this.perm[d],e-1,t-1,n),i),s),this.lerp(this.lerp(this.grad(this.perm[p+1],e,t,n-1),this.grad(this.perm[h+1],e-1,t,n-1),i),this.lerp(this.grad(this.perm[m+1],e,t-1,n-1),this.grad(this.perm[d+1],e-1,t-1,n-1),i),s),c)},simplex2D:function(e,t){const n=this.F2,r=this.G2;let a,o,l=(e+t)*n,i=Math.floor(e+l),s=Math.floor(t+l),c=(i+s)*r,u=e-(i-c),p=t-(s-c);u>p?(a=1,o=0):(a=0,o=1);let m=u-a+r,f=p-o+r,h=u-1+2*r,d=p-1+2*r,v=255&i,y=255&s,w=.5-u*u-p*p,g=.5-m*m-f*f,N=.5-h*h-d*d;return 70*((w<0?0:Math.pow(w,4)*this.dot(this.grad3[this.perm[v+this.perm[y]]%12],u,p))+(g<0?0:Math.pow(g,4)*this.dot(this.grad3[this.perm[v+a+this.perm[y+o]]%12],m,f))+(N<0?0:Math.pow(N,4)*this.dot(this.grad3[this.perm[v+1+this.perm[y+1]]%12],h,d)))},fractalNoise:function(e,t,n=4,r=.5,a=2){let o=0,l=1,i=1,s=0;for(let c=0;c<n;c++)o+=this.perlin2D(e*l,t*l)*i,s+=i,i*=r,l*=a;return o/s},dot:function(e,t,n){return e[0]*t+e[1]*n},dot3:function(e,t,n,r){return e[0]*t+e[1]*n+e[2]*r}};return e.init(),e},createOs=function(){return(()=>{const e="undefined"!=typeof process&&process.versions?.node,t={};return{...{time:()=>Math.floor(Date.now()),date:(e,t)=>{const n=t?new Date(1e3*t):new Date,r={"%Y":n.getFullYear(),"%m":(n.getMonth()+1).toString().padStart(2,"0"),"%d":n.getDate().toString().padStart(2,"0"),"%H":n.getHours().toString().padStart(2,"0"),"%M":n.getMinutes().toString().padStart(2,"0"),"%S":n.getSeconds().toString().padStart(2,"0"),"%w":n.getDay(),"%j":Math.floor((n-new Date(n.getFullYear(),0,0))/864e5),"%c":n.toLocaleString(),"%x":n.toLocaleDateString(),"%X":n.toLocaleTimeString()};return e.replace(/%./g,(e=>r[e]||e))},difftime:(e,t)=>e-t,clock:()=>{if(e){const e=process.hrtime();return e[0]+e[1]/1e9}return 1e3*performance.now()},sleep:async(...e)=>await new Promise((t=>setTimeout(t,...e)))},...e?{execute:e=>{const{execSync:t}=require("child_process");try{return[0,t(e).toString()]}catch(n){return[n.status,n.message]}},getenv:e=>process.env[e]||null,exit:(e=0)=>process.exit(e),tmpname:()=>`${require("os").tmpdir()}/tmp_${Math.random().toString(36).substr(2)}`}:{execute:()=>[null,"execute not supported in browser"],getenv:e=>{try{return localStorage.getItem(e)}catch{return t[e]||null}},exit:()=>console.warn("exit() ignored in browser"),tmpname:()=>`tmp_${Math.random().toString(36).substr(2)}.tmp`,setenv:(e,n)=>{try{localStorage.setItem(e,n)}catch{t[e]=n}}}}})()},createString=function(){const escapeRegex=function(e){return e.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&")};return{byte:(e,t=0)=>e.charCodeAt(t),char:(...e)=>String.fromCharCode(...e),dump:e=>e.toString(),find:(e,t,n=0,r=!1)=>{n=Math.max(n,0),r&&(t=escapeRegex(t));const a=new RegExp(t),o=e.slice(n).match(a);return o?{0:o.index+n,1:o.index+n+o[0].length-1}:null},format:(e,...t)=>{let n=0;return e.replace(/%([%scdefgiouxXq])/g,((e,r)=>{if("%"===r)return"%";if(n>=t.length)return e;const a=t[n++];switch(r){case"s":return String(a);case"c":return String.fromCharCode(Number(a));case"d":case"i":return parseInt(a,10).toString();case"e":return Number(a).toExponential();case"f":return Number(a).toFixed(6);case"g":return Number(a).toPrecision();case"o":return parseInt(a,10).toString(8);case"u":return Math.abs(parseInt(a,10)).toString();case"x":return parseInt(a,10).toString(16);case"X":return parseInt(a,10).toString(16).toUpperCase();case"q":return`"${String(a).replace(/"/g,'\\"')}"`;default:return e}}))},gmatch:(e,t)=>{const n=new RegExp(t,"g");let r;return{next:()=>{if(r=n.exec(e),r){const e={};return r.slice(0).forEach(((t,n)=>e[n]=t)),{value:e,done:!1}}return{value:undefined,done:!0}},[Symbol.iterator](){return this}}},gsub:async(e,t,n,r=Infinity)=>{let a,o,l=0,i="",s=0;for(a="string"==typeof t?new RegExp(t,"g"):t;null!==(o=a.exec(e))&&l<r;){let t;if(i+=e.substring(s,o.index),"function"==typeof n){const e={};o.slice(0).forEach(((t,n)=>e[n]=t)),t=await n(e)}else t="string"==typeof n?n.replace(/%(\d+)/g,((e,t)=>{const n=parseInt(t);return o[n]||e})):String(n);i+=t,s=o.index+o[0].length,l++,a.lastIndex===s&&s<e.length&&a.lastIndex++}return i+=e.substring(s),i},len:e=>e.length,lower:e=>e.toLowerCase(),match:(e,t,n=0)=>{const r=new RegExp(t),a=e.substring(n).match(r);if(a){const e={};return a.length>1?a.slice(1).forEach(((t,n)=>e[n]=t)):e[0]=a[0],e}return null},rep:(e,t)=>e.repeat(t),reverse:e=>e.split("").reverse().join(""),sub:(e,t,n)=>(t=t>=0?t:e.length+t,n=(n=n??e.length)>=0?n:e.length+n,e.slice(t,n+1)),upper:e=>e.toUpperCase(),split:(e,t)=>{if(!t){const t=e.trim().split(/\s+/),n={};return t.forEach(((e,t)=>n[t]=e)),n}const n=new RegExp(escapeRegex(t)),r=e.split(n),a={};return r.forEach(((e,t)=>a[t]=e)),a},trim:e=>e.trim(),ltrim:e=>e.replace(/^\s+/,""),rtrim:e=>e.replace(/\s+$/,""),startsWith:(e,t)=>e.startsWith(t),endsWith:(e,t)=>e.endsWith(t),contains:(e,t)=>e.includes(t),padLeft:(e,t,n=" ")=>e.padStart(t,n),padRight:(e,t,n=" ")=>e.padEnd(t,n),capitalize:e=>e.charAt(0).toUpperCase()+e.slice(1).toLowerCase(),isEmpty:e=>0===e.length,count:(e,t,n=0,r=e.length)=>(e.slice(n,r).match(new RegExp(escapeRegex(t),"g"))||[]).length,join:(e,t="")=>Object.values(e).join(t),replaceFirst:(e,t,n)=>e.replace(t,n),toBytes:e=>{const t=Array.from(e).map((e=>e.charCodeAt(0))),n={};return t.forEach(((e,t)=>n[t]=e)),n},fromBytes:e=>{const t=Object.values(e);return String.fromCharCode(...t)}}},createTable=function(){const clone=e=>"object"==typeof e&&null!==e?Object.fromEntries(Object.entries(e).map((([e,t])=>[e,clone(t)]))):e,toArray=e=>Object.entries(e).sort(((e,t)=>Number(e[0])-Number(t[0]))).map((([e,t])=>t)),fromArray=e=>Object.fromEntries(e.map(((e,t)=>[t,e]))),updateTable=(e,t)=>{Object.keys(e).forEach((t=>delete e[t])),t.forEach(((t,n)=>e[n]=t))};return{concat:(e,t,n,r)=>{t=t||"",n=n||0;const a=toArray(e);r=r||a.length-1;const o=[];for(let l=n;l<=r;l++)a[l]!==undefined&&o.push(String(a[l]));return o.join(t)},insert:(e,t,n)=>{const r=toArray(e);return n===undefined&&(n=t,t=r.length),r.splice(t,0,n),updateTable(e,r),e},remove:(e,t)=>{const n=toArray(e);if((t=t===undefined?n.length-1:t)<0||t>=n.length)return null;const r=n.splice(t,1)[0];return updateTable(e,n),r},sort:async(e,t)=>{const n=toArray(e),quickSort=async(e,n,r)=>{if(n<r){const a=await(async(e,n,r)=>{const a=e[r];let o=n-1;for(let l=n;l<r;l++)(t?await t(e[l],a):e[l]<=a)&&(o++,[e[o],e[l]]=[e[l],e[o]]);return[e[o+1],e[r]]=[e[r],e[o+1]],o+1})(e,n,r);quickSort(e,n,a-1),quickSort(e,a+1,r)}};return await quickSort(n,0,n.length-1),updateTable(e,n),e},move:(e,t,n,r,a)=>{const o=toArray(e),l=toArray(a=a||e);t=t===undefined?0:t,n=n===undefined?o.length-1:n,r=r===undefined?0:r;const i=o.slice(t,n+1);for(let s=0;s<i.length;s++)l[r+s]=i[s];return updateTable(a,l),a},sub:(e,t,n)=>{const r=toArray(e);return t=t||0,n=n||r.length,fromArray(r.slice(t,n))},maxn:e=>Math.max(...Object.keys(e).map(Number).filter((e=>!isNaN(e)))),pack:(...e)=>fromArray(e),unpack:(e,t,n)=>{const r=toArray(e);return t=t||0,n=n||r.length,r.slice(t,n)},find:(e,t,n)=>{const r=toArray(e);for(let a=n=n||0;a<r.length;a++)if(r[a]===t)return a;return null},filter:async(e,t)=>{const n=toArray(e),r=[];for(let a=0;a<n.length;a++)await t(n[a])&&r.push(n[a]);return fromArray(r)},map:async(e,t)=>{const n=toArray(e),r=[];for(let a=0;a<n.length;a++)r[a]=await t(n[a],a);return updateTable(e,r),e},forEach:async(e,t)=>{const n=toArray(e);for(let r=0;r<n.length;r++)await t(n[r],r)},reduce:async(e,t,n)=>{const r=toArray(e);let a=n!==undefined?n:r[0];for(let o=n!==undefined?0:1;o<r.length;o++)a=await t(a,r[o],o);return a},reverse:e=>{const t=toArray(e);return updateTable(e,t.reverse()),e},contains:(e,t)=>toArray(e).includes(t),count:(e,t)=>toArray(e).reduce(((e,n)=>e+(n===t?1:0)),0),merge:(e,t)=>fromArray([...toArray(e),...toArray(t)]),unique:e=>fromArray([...new Set(toArray(e))]),shuffle:e=>{const t=toArray(e);for(let n=t.length-1;n>0;n--){const e=Math.floor(Math.random()*(n+1));[t[n],t[e]]=[t[e],t[n]]}return updateTable(e,t),e},isEmpty:e=>0===Object.keys(e).length,clone:clone,indexOf:(e,t,n)=>toArray(e).indexOf(t,n||0),lastIndexOf:(e,t)=>toArray(e).lastIndexOf(t),every:(e,t)=>toArray(e).every(t),some:(e,t)=>toArray(e).some(t)}};class ReturnSignal extends Error{constructor(e){super(),this.value=e}}class BreakSignal extends Error{}const e={math:createMath(),json:createJson(),os:createOs(),string:createString(),table:createTable(),dom:createDom(),_G:{},print:function(...e){console.log(...e)},pcall:async(e,...t)=>{try{if("function"!=typeof e)return{result:null,error:"Attempt to call a non-function",isComplete:!1};return{result:await e(...t),error:null,isComplete:!0}}catch(error){return console.error("pcall caught error:",error),{result:null,error:error.message,isComplete:!1}}},len:async function(...e){let t=0;for(const n of e)t+=tonumber(Array.isArray(n)||"string"==typeof n?n.length:Object.keys(n).length);return t},warn:e=>{console.warn(e)},assert:(e,t)=>{if(!e)throw new Error(`Assertion failed: ${t||"Condition is false"}`)},xpcall:async(e,t,...n)=>{try{return{result:await e(...n),error:null,isComplete:!0}}catch(error){try{const n=await t(error);return{result:n,error:error.message,isComplete:!1,handled:!0}}catch(r){return console.error("Error handler failed:",r),{result:null,error:r.message,isComplete:!1,handled:!1}}}},type:type,tostring:function(e){return String(e)},tonumber:tonumber,error:error,ipairs:e=>{let t=e;if("table"===type(e)&&(t=(e=>Object.entries(e).sort(((e,t)=>Number(e[0])-Number(t[0]))).map((([e,t])=>t)))(e)),!Array.isArray(t)&&"string"!=typeof t)throw new Error("ipairs expects array-like table");let n=0;return createIterator((()=>n<t.length?[n,t[n++]]:null))},pairs:e=>{if(Array.isArray(e)){const t=Object.keys(e);return createIterator((()=>{if(n<t.length){const r=t[n];return n++,[Number(r),e[r]]}return null}))}const t=Object.keys(e);let n=0;return createIterator((()=>{if(n<t.length){const r=t[n];return n++,[r,e[r]]}return null}))},next:(e,t)=>{const n=Object.keys(e);let r=null===t?0:n.indexOf(t)+1;if(r<n.length){const t=n[r];return[t,e[t]]}return null},console:console,setTimeout:setTimeout,setInterval:setInterval,clearInterval:clearInterval,await:async function(e,...t){return await e(...t)},awaitListener:function(e,t,...n){!async function(){const r=await e(...n);t(r)}()},loadstring:async function(e){const t="loadstring",n=(new Date).toISOString(),r=parse(tokenize(e,t)),a=new Interpreter;try{return await a.run(r,t)}catch(error){throw console.error(`Error during execution of ${t} at ${n}:`,error),error}},loadscript:async function(t){const n=(new Date).toISOString();try{if("undefined"!=typeof window){const e=new Blob([t],{type:"application/javascript"}),n=URL.createObjectURL(e),r=await import(n);return URL.revokeObjectURL(n),r["default"]||r}{const n=require("vm"),r=new n.Script(t),a=n.createContext(Object.create(e));return r.runInContext(a),a}}catch(error){throw console.error(`Error during execution of loadscript at ${n}:`,error),error}},setenv:function(e,t){if("function"!=typeof e)throw new Error("setenv expects a function as the first argument");if(null!==t&&"object"!=typeof t)throw new Error("setenv expects an object or null as the second argument");e.env=t||null}};"undefined"!=typeof window&&(e.window=window,e.document=document,e.localStorage=localStorage,e.requestAnimationFrame=requestAnimationFrame,e.eval=eval,"undefined"!=typeof indexedDB&&(e.indexedDB=indexedDB)),e.__global=e;const t=[];class Interpreter{constructor(n={},r=null){this.globalEnv={...e},t.push(this.globalEnv),this.env=this.createEnvironment(this.globalEnv),this.moduleCache=n,this.currentModulePath=r,this.requireJs={noise:()=>createNoise(),http:()=>({get:async e=>{const t=await fetch(e);if(!t.ok)throw new Error(`HTTP error! Status: ${t.status}`);return{body:await t.json()}},post:async(e,t)=>{const n=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!n.ok)throw new Error(`HTTP error! Status: ${n.status}`);return{body:await n.json()}}}),math:()=>createMath(),json:()=>createJson(),os:()=>createOs(),string:()=>createString(),table:()=>createTable(),dom:()=>createDom()},this.functionCache=new Map,this.classPrototypes=new Map,this.privateFields=new WeakMap,this.typeAnnotations=new Map}checkType(e,t,n){const r=type(e);if(t&&!new Set(t).has(r))throw new Error(`Type mismatch: expected ${t.join(" or ")}, got ${r} at line ${n.line}, column ${n.column}, fileName ${n.fileName}`)}createEnvironment(e){return Object.create(e||null)}resolveModulePath(e,t){if(e.startsWith(".")){const r=t||this.currentModulePath;if(!r){if("undefined"!=typeof window){return`${window.location.href.split("/").slice(0,-1).join("/")||"/"}/${e}`.replace(/\/+/g,"/")}if("undefined"!=typeof require&&require.resolve)try{return require.resolve(e)}catch(n){throw new Error(`Cannot resolve relative path '${e}' without current module path: ${n.message}`)}throw new Error("Cannot resolve relative path without current module path")}return`${r.split("/").slice(0,-1).join("/")}/${e}`.replace(/\/+/g,"/")}return e}async readFile(e){if("undefined"!=typeof window)try{const t=await fetch(e);if(!t.ok)throw new Error(`Failed to load module: ${e}. Status: ${t.status}`);return await t.text()}catch(t){throw new Error(`Failed to load module: ${e}. ${t}`)}else{if("undefined"==typeof require)throw new Error("No file reading mechanism available in this environment");try{return require("fs").readFileSync(e,"utf-8")}catch(error){throw new Error(`Failed to read file: ${e}. ${error.message}`)}}}async loadModule(e,t){if(this.requireJs[e])return await this.requireJs[e]();let n=this.resolveModulePath(e,t);if(this.moduleCache[n])return this.moduleCache[n].exports;const r=[];let a,o;n.endsWith(".js")||n.endsWith(".xylo")?r.push(n):r.push(`${n}.xylo`,n,`${n}.js`);for(const i of r)try{o=await this.readFile(i),a=i;break}catch(l){continue}if(!a){if("undefined"!=typeof require&&!e.startsWith("."))try{const t=require(e);return this.moduleCache[n]={exports:t["default"]||t},t["default"]||t}catch(l){throw new Error(`Module not found: ${e} (tried: ${r.join(", ")}) and Node.js require failed: ${l.message}`)}throw new Error(`Module not found: ${e} (tried: ${r.join(", ")})`)}if(a.endsWith(".xylo")){const e=parse(tokenize(o,a)),n=new Interpreter(this.moduleCache,this.currentModulePath||t);n.currentModulePath=a;const r={};return n.env.exports=r,await n.run(e),this.moduleCache[a]={exports:r},r}if(a.endsWith(".js"))try{if("undefined"!=typeof window){const e=await import(a);return this.moduleCache[a]={exports:e["default"]||e},e["default"]||e}{const e=require(a);return this.moduleCache[a]={exports:e["default"]||e},e["default"]||e}}catch(l){throw new Error(`JS module load error: ${l.message}`)}throw new Error(`Unsupported module type: ${a}`)}async evaluate(e){try{switch(e.type){case"LocalDeclaration":return await this.handleLocalDeclaration(e);case"AssignmentExpression":return await this.handleAssignment(e);case"FunctionDefinition":this.env[e.name]=this.createFunction(e);break;case"FunctionMethodDefinition":this.env[e.object.value][e.name]=this.createFunction(e);break;case"FunctionCall":return await this.handleFunctionCallAsync(e);case"FunctionMethodCall":return await this.handleFunctionMethodCallAsync(e);case"MemberExpression":return await this.handleMemberAccessAsync(e);case"WhileStatement":return await this.handleWhileStatementAsync(e);case"ForStatement":return await this.handleForStatementAsync(e);case"ForInStatement":return await this.handleForInStatementAsync(e);case"IfStatement":return await this.handleIfStatementAsync(e);case"BinaryExpression":return await this.evaluateBinaryExpressionAsync(e);case"UnaryExpression":return await this.evaluateUnaryExpressionAsync(e);case"UpdateExpression":return await this.handleUpdateExpressionAsync(e);case"ReturnStatement":return await this.evaluateValueAsync(e.argument);case"ClassDefinition":this.env[e.name]=this.createClass(e);break;case"ClassInstantiation":return await this.handleClassInstantiation(e);case"BreakStatement":throw new BreakSignal;case"SwitchStatement":return await this.handleSwitchStatementAsync(e);case"TryStatement":return await this.handleTryStatementAsync(e);case"RequireStatement":return await this.loadModule(e.moduleName,this.currentModulePath);case"GlobalDeclaration":return await this.handleGlobalDeclaration(e);default:throw new Error(`Unknown node type: ${e.type} at line ${e.line}, column ${e.column}, fileName ${e.fileName}`)}}catch(error){if(!error.message.includes("line")&&e.line!==undefined&&e.column!==undefined)throw new Error(`${error.message} at line ${e.line}, column ${e.column}, fileName ${e.fileName}`);throw error}}async evaluateValueAsync(e){if(e.typeAnnotation&&this.checkType(value,e.typeAnnotation,e),"Number"===e.type||"Boolean"===e.type)return e.value;if("String"===e.type)return e.value.replaceAll("\\n","\n");if("Nil"===e.type)return null;switch(e.type){case"Identifier":if(!(e.value in this.env))throw new Error(`Undefined variable: ${e.value} at line ${e.line}, column ${e.column}, fileName ${e.fileName}`);return this.env[e.value];case"Table":return await this.createTable(e);case"MemberExpression":return await this.handleMemberAccessAsync(e);case"AssignmentExpression":return await this.handleAssignment(e);case"FunctionCall":return await this.handleFunctionCallAsync(e);case"FunctionMethodCall":return await this.handleFunctionMethodCallAsync(e);case"FunctionDefinition":return this.createFunction(e);case"ClassDefinition":return this.createClass(e);case"ClassInstantiation":return await this.handleClassInstantiation(e);case"BinaryExpression":return await this.evaluateBinaryExpressionAsync(e);case"UnaryExpression":return await this.evaluateUnaryExpressionAsync(e);case"RequireStatement":return await this.loadModule(e.moduleName,this.currentModulePath);case"VarargExpression":if(!("..."in this.env))throw new Error(`Vararg '...' used outside of vararg function at line ${e.line}, column ${e.column}, fileName ${e.fileName}`);return this.env["..."];default:throw new Error(`Unsupported value type: ${e.type} at line ${e.line}, column ${e.column}, fileName ${e.fileName}`)}}async handleClassInstantiation(e){const t=await this.evaluateValueAsync(e.callee);if(!t||"function"!=typeof t)throw new Error(`Cannot instantiate non-class '${e.callee.value}' at line ${e.line}, column ${e.column}, fileName ${e.fileName}`);const n=await Promise.all(e.arguments.map((e=>this.evaluateValueAsync(e))));return await t(...n)}async handleGlobalDeclaration(e){const n=e.identifier.value;let r=null;e.value&&(r=await this.evaluateValueAsync(e.value),this.checkType(r,e.typeAnnotation,e)),e.typeAnnotation&&this.typeAnnotations.set(n,e.typeAnnotation);for(const a in t)t[a][n]=r;return this.globalEnv.__global[n]=r,r}async handleLocalDeclaration(e){const t=e.identifier.value;let n=null;return e.value&&(n=await this.evaluateValueAsync(e.value),this.checkType(n,e.typeAnnotation,e)),e.typeAnnotation&&this.typeAnnotations.set(t,e.typeAnnotation),this.env[t]=n,n}async handleSwitchStatementAsync(e){const t=await this.evaluateValueAsync(e.discriminant);let n=!1,r=null;try{for(const a of e.cases){if(t===await this.evaluateValueAsync(a.test)){n=!0;for(const e of a.body)r=await this.evaluate(e);break}}if(!n&&e.defaultCase)for(const t of e.defaultCase.body)r=await this.evaluate(t)}catch(a){if(a instanceof BreakSignal)return r;throw a}return r}async handleTryStatementAsync(e){try{let t=null;for(const n of e.block)t=await this.evaluate(n);return t}catch(error){if(e.handler){const n=this.createEnvironment(this.env);n[e.handler.param.value]=error.message||error;const r=new Interpreter(this.moduleCache);r.env=n,r.globalEnv=this.globalEnv,r.currentModulePath=this.currentModulePath;let a=null;for(const t of e.handler.body)a=await r.evaluate(t);return a}throw error}}async handleAssignment(e){const t=e.target,n=await this.evaluateValueAsync(e.value);if("Identifier"===t.type){const r=t.value;let a=this.env,o=null;for(;null!==a;){if(Object.prototype.hasOwnProperty.call(a,r)){o=a;break}a=Object.getPrototypeOf(a)}e.typeAnnotation&&this.typeAnnotations.set(r,e.typeAnnotation);const l=this.typeAnnotations.get(r);l&&this.checkType(n,l,e),null!==o?(o[r]=n,this.env[r]=n):(this.globalEnv[r]=n,this.env[r]=n)}else if("MemberExpression"===t.type){const r=await this.evaluateValueAsync(t.object),a=t.computed?await this.evaluateValueAsync(t.property):t.property.value;if(this.privateFields.has(r)&&this.privateFields.get(r).has(a)){if(this.env.self!==r)throw new Error(`Cannot assign to private field '${a}' at line ${e.line}, column ${e.column}, fileName ${e.fileName}`);this.privateFields.get(r).set(a,n)}else r[a]=n}return n}createFunction(e){const t=JSON.stringify({params:e.params,body:e.body});if(this.functionCache.has(t))return this.functionCache.get(t);let n=!1;const r=e.params.length,func=async(...t)=>{const a=this.env;this.env=func.env||this.createEnvironment(this.env);let o=[];if(e.hasVararg){const n=e.params.length-1;o=t.slice(n),t.length=n}if(n)for(let n=0;n<r;n++){const r=e.params[n];this.env[r.value]="Vararg"===r.type?o:t[n]}else{for(let n=0;n<r;n++){const r=e.params[n];r.typeAnnotation&&this.checkType(t[n],r.typeAnnotation,r),this.env[r.value]="Vararg"===r.type?o:t[n]}n=!0}let l=null;for(const n of e.body)if(l=await this.evaluate(n),"ReturnStatement"===n.type)return this.checkType(l,e.returnType,e),this.env=a,l;return this.checkType(l,e.returnType,e),this.env=a,l};return func.isAsync=e.isAsync,func.env=this.createEnvironment(this.env),this.functionCache.set(t,func),func}async handleFunctionMethodCallAsync(e){let t;try{t=await this.evaluateValueAsync(e.callee.property)}catch{t=await this.evaluateValueAsync(e.callee)}const n=[];for(const r of e.arguments)n.push(await this.evaluateValueAsync(r));if("function"!=typeof t&&(n.unshift(t),t=t[e.callee.property.value]),"function"!=typeof t)throw new Error(`Trying to call non-function: ${typeof t} at line ${e.line}, column ${e.column}, fileName ${e.fileName}`);return t.isAsync?(t(...n)["catch"]((e=>{throw console.error("Async error:",e.message),new Error("Stop program.")})),undefined):await t(...n)}async handleFunctionCallAsync(e){const t=await this.evaluateValueAsync(e.callee),n=[];for(const r of e.arguments)n.push(await this.evaluateValueAsync(r));if("function"!=typeof t)throw new Error(`Trying to call non-function: ${typeof t} at line ${e.line}, column ${e.column}, fileName ${e.fileName}`);return t.isAsync?(t(...n)["catch"]((e=>{throw console.error("Async error:",e.message),new Error("Stop program.")})),undefined):await t(...n)}async handleMemberAccessAsync(e){const t=await this.evaluateValueAsync(e.object),n=e.computed?await this.evaluateValueAsync(e.property):e.property.value;if(null===t||t===undefined)throw new Error(`Cannot read property '${n}' of null/undefined at line ${e.line}, column ${e.column}, fileName ${e.fileName}`);if(this.privateFields.has(t)&&this.privateFields.get(t).has(n)){if(this.env.self!==t)throw new Error(`Cannot access private field '${n}' at line ${e.line}, column ${e.column}, fileName ${e.fileName}`);return this.privateFields.get(t).get(n)}const r=t[n];return"function"==typeof r&&t!==window&&t!==document?r.bind(t):r}async createTable(e){const t={};for(const n of e.properties){const r=await this.evaluateValueAsync(n.key),a=await this.evaluateValueAsync(n.value);e.typeAnnotation&&this.checkType(a,e.typeAnnotation,e),t[r]=a}return t}async handleWhileStatementAsync(e){try{for(;this.convertToBoolean(await this.evaluateValueAsync(e.condition));)try{for(const t of e.body)await this.evaluate(t)}catch(t){if(t instanceof BreakSignal)break;throw t}}catch(t){if(t instanceof BreakSignal)throw new Error(`Break outside of loop at line ${e.line}, column ${e.column}, fileName ${e.fileName}`);throw t}}async handleForStatementAsync(e){const t=e.variable.value,n=await this.evaluateValueAsync(e.start),r=await this.evaluateValueAsync(e.end),a=await this.evaluateValueAsync(e.step);if(this.env[t]=n,a>0)for(;this.env[t]<=r;){for(const t of e.body)await this.evaluate(t);this.env[t]+=a}else for(;this.env[t]>=r;){for(const t of e.body)await this.evaluate(t);this.env[t]+=a}}async handleForInStatementAsync(e){const t=e.keyVariable.value,n=e.valueVariable.value,r=e.iteratorCall,a=await this.evaluateValueAsync(r.callee),o=await this.evaluateValueAsync(r.arguments[0]),l=await a(o);let i=await l.next();try{for(;!i.done;){const[r,a]=i.value;this.env[t]=r,this.env[n]=a;try{for(const t of e.body)await this.evaluate(t)}catch(s){if(s instanceof BreakSignal)break;throw s}i=await l.next()}}catch(s){if(s instanceof BreakSignal)throw new Error(`Break outside of loop at line ${e.line}, column ${e.column}, fileName ${e.fileName}`);throw s}}async handleIfStatementAsync(e){if(this.convertToBoolean(await this.evaluateValueAsync(e.condition)))for(const t of e.thenBody)await this.evaluate(t);else for(const t of e.elseBody)await this.evaluate(t)}async evaluateBinaryExpressionAsync(e){const t=await this.evaluateValueAsync(e.left),n=await this.evaluateValueAsync(e.right);switch(e.operator){case"+":return t+n;case"-":return t-n;case"*":return t*n;case"/":return t/n;case"==":return t===n;case"..":return String(t)+String(n);case"and":return this.convertToBoolean(t)?n:t;case"or":return this.convertToBoolean(t)?t:n;case"<":return t<n;case"<=":return t<=n;case">":return t>n;case">=":return t>=n;case"~=":case"!=":return t!=n;case"%":return t%n;case"^":return Math.pow(t,n);case"&&":return this.convertToBoolean(t)&&this.convertToBoolean(n);case"||":return this.convertToBoolean(t)||this.convertToBoolean(n)}throw new Error(`Unknown operator: ${e.operator}`)}async evaluateUnaryExpressionAsync(e){const t=await this.evaluateValueAsync(e.argument);switch(e.operator){case"unary-":if("number"!=typeof t)throw new Error("Unary '-' cannot be applied to type "+typeof t);return-t;case"not":return!this.convertToBoolean(t);default:throw new Error(`Unknown unary operator: ${e.operator}`)}}convertToBoolean(e){return"boolean"==typeof e?e:null!==e&&e!==undefined&&("number"==typeof e?0!==e:"string"!=typeof e||""!==e)}createClass(e){const t=this.createEnvironment(this.env),n={};for(const a of e.staticFields)t[a.name]=a.value?this.evaluateValueAsync(a.value):null;for(const a of e.staticMethods)t[a.name]=this.createFunction(a);for(const a of e.fields)a.isPrivate||(n[a.name]=a.value?this.evaluateValueAsync(a.value):null);for(const a of e.methods)n[a.name]=this.createFunction(a);if(e.parent){const t=this.env[e.parent.value];if(!t||!t.prototype)throw new Error(`Parent class '${e.parent.value}' not found at line ${e.line}, column ${e.column}, fileName ${e.fileName}`);Object.setPrototypeOf(n,t.prototype)}const r=n.init||(async e=>e),classObj=async(...t)=>{const a=Object.create(n),o=new Map;this.privateFields.set(a,o);for(const n of e.fields)n.isPrivate&&o.set(n.name,n.value?await this.evaluateValueAsync(n.value):null);const l=this.createEnvironment(this.env);l.self=a;for(const e in n)"function"==typeof n[e]&&(n[e].env=l);return await r.call(a,a,...t),a};classObj.prototype=n;for(const[a,o]of Object.entries(t))classObj[a]=o;return this.classPrototypes.set(e.name,n),classObj}async handleUpdateExpressionAsync(e){const t=e.argument;if("Identifier"===t.type){const n=t.value;if(!(n in this.env))throw new Error(`Undefined variable '${e.value}' at line ${e.line}, column ${e.column}, fileName ${e.fileName}`);const r=this.env[n];if("number"!=typeof r)throw new Error(`Increment/decrement operator can only be applied to numbers at line ${e.line}, column ${e.column}, fileName ${e.fileName}`);const a=r+("++"===e.operator?1:-1);let o=this.env,l=null;for(;null!==o;){if(Object.prototype.hasOwnProperty.call(o,n)){l=o;break}o=Object.getPrototypeOf(o)}return null!==l?(l[n]=a,this.env[n]=a):this.globalEnv[n]=a,e.prefix?a:r}if("MemberExpression"===t.type){const n=await this.evaluateValueAsync(t.object),r=await this.evaluateValueAsync(t.property);if("object"!=typeof n||null===n)throw new Error(`Cannot read property '${r}' of non-object at line ${e.line}, column ${e.column}, fileName ${e.fileName}`);if("number"!=typeof n[r])throw new Error(`Increment/decrement operator can only be applied to numbers at line ${e.line}, column ${e.column}, fileName ${e.fileName}`);const a=n[r],o=a+("++"===e.operator?1:-1);return n[r]=o,e.prefix?o:a}throw new Error(`Invalid argument for update expression at line ${e.line}, column ${e.column}, fileName ${e.fileName}`)}async run(e,t){let n=null;try{for(const t of e)n=await this.evaluate(t)}catch(r){if(r instanceof ReturnSignal)return r.value;throw r}return n}}let n;function runXylo(e,t){const r="main.xylo",a=(new Date).toISOString();let o;o="undefined"!=typeof window?window.location.href.split("/").slice(0,-1).join("/")||"/":"undefined"!=typeof __dirname?__dirname:"";const l=parse(tokenize(e,r));n=new Interpreter,n.currentModulePath=t||o;try{return n.run(l,r)}catch(error){throw console.error(`Error during execution of ${r} at ${a}:`,error),error}}export{runXylo};