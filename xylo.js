/*
Phoenix Developer License (PDL), Version 1.0
Copyright Max-Dil, 2025
Software Usage Terms
This license governs your use of the software, its source code, components, and related materials (hereinafter referred to as the "Software").
By accepting the terms of this license, you agree to comply with its provisions.
By editing the source code, you automatically accept the license.
1. Grant of Rights
The Licensor grants you a non-exclusive, non-transferable, limited right to:
Use the Software on any number of devices.
Modify the source code for personal purposes or internal use.
2. Restrictions
You are prohibited from:
Distributing, publishing, or transferring the source code of the Software or its modified versions to third parties without written permission from the Licensor.
Using the Software for purposes that violate the laws of your jurisdiction.
Removing, obscuring, or altering copyright notices or license terms from the source code.
3. Disclaimer of Warranties and Liability
The Software is provided "as is," without any warranties, express or implied.
The Licensor shall not be held liable for any direct, indirect, incidental, consequential damages, loss of profits, or other losses arising from the use or inability to use the Software.
4. Copyright and Modification
All rights to the source code, structure, logic, and documentation belong to the Licensor.
Any modifications to the Software are considered derivative works. Their distribution requires written consent from the Licensor.
5. Termination
This license automatically terminates if you breach its terms. In such cases, you must destroy all copies of the Software.
6. Governing Law
This license is governed by the laws of the Russian Federation. Disputes shall be resolved in the courts of the respective jurisdiction.
*/

function getLineAndColumn(e,t){let n=1,r=1;for(let a=0;a<t;a++)"\n"===e[a]?(n++,r=1):r++;return{line:n,column:r}}function tokenize(e,t){const n=[],r=/([a-zA-Z_\u0410-\u044F][a-zA-Z0-9_\u0410-\u044F]*)|((==|\+\+|!=|<=|>=|&&|\.\.\.|\|\||\.\.|~=|=|\{|\}|[()]|,|:|;|\[|\]|<|>|\+|-|\*|\/|%|\^|\.|end|then|if|else|true|false|nil|require|and|or|not|local|global|break|class|extends|static|private|public|init|number|string|boolean|function|table|null|undefined))|(\d+\.?\d*)|('[^']*')|("[\s\S]*?")|(\/\/.*)|(--.*)|(\|)/gy;let a=0;for(;a<e.length;){if("--"===e.slice(a,a+2)||"//"===e.slice(a,a+2)){a=e.indexOf("\n",a),-1===a?a=e.length:a++;continue}r.lastIndex=a;const o=r.exec(e);if(!o||o&&";"===o[0]){a++;continue}const l=o.index,i=o[0],{line:s,column:c}=getLineAndColumn(e,l);let u=i;i.startsWith("'")&&i.endsWith("'")&&(u=`"${i.slice(1,-1)}"`),n.push({value:u,line:s,column:c,fileName:t}),a=r.lastIndex}return n}function parse(e){let t=0;function n(){return e[t]||null}function r(){return e[t++]}function a(e=!1){if(n()&&":"===n().value){r();const t=[];for(;n()&&["number","string","boolean","function","table","null","undefined"].includes(n().value);)t.push(r()),n()&&"|"===n().value&&r();if(0===t.length&&!e)throw console.error(`Expected type after ':' at line ${n()?.line}, column ${n()?.column}, fileName ${n()?.fileName}`),new Error("Stop program.");return t.map((e=>e.value))}return null}function o(e){switch(e){case"unary-":case"not":return 7;case"^":case"*":case"/":case"%":return 6;case"+":case"-":return 5;case"..":return 4;case"<":case">":case"<=":case">=":case"==":case"~=":case"!=":case"in":return 3;case"&&":case"and":return 2;case"||":case"or":return 1;default:return 0}}function l(){return function(e){let t=i();const a=[];for(;n();){const l=n(),s=o(l.value);if(!s||s<=e)break;r(),a.push({left:t,operator:l.value,line:l.line,column:l.column,fileName:l.fileName}),t=i()}for(;a.length;){const{left:e,operator:n,line:r,column:o,fileName:l}=a.pop();t={type:"BinaryExpression",operator:n,left:e,right:t,line:r,column:o,fileName:l}}return t}(0)}function i(){let o=r();if(!o)return null;if("("===o.value){const n=l();let a=r();if(a||(a=e[t-1]?e[t-1]:e[e.length-1]),!a||")"!==a.value)throw console.error(`Expected ')' at line ${a?.line}, column ${a?.column}, fileName: ${a?.fileName}`),new Error("Stop program.");return n}if("local"===o.value)return function(e){const t=r();if(!/^[\p{L}_][\p{L}\p{N}_]*$/u.test(t.value))throw console.error(`Expected identifier at line ${t.line}, column ${t.column}, fileName ${t.fileName}`),new Error("Stop program.");const o=a();let i=null;n()&&"="===n().value&&(r(),i=l());return{type:"LocalDeclaration",identifier:{type:"Identifier",value:t.value,line:t.line,column:t.column,fileName:t.fileName},value:i,typeAnnotation:o,line:e.line,column:e.column,fileName:e.fileName}}(o);if("global"===o.value)return function(e){const t=r();if(!/^[\p{L}_][\p{L}\p{N}_]*$/u.test(t.value))throw console.error(`Expected identifier at line ${t.line}, column ${t.column}, fileName ${t.fileName}`),new Error("Stop program.");const o=a();let i=null;n()&&"="===n().value&&(r(),i=l());return{type:"GlobalDeclaration",identifier:{type:"Identifier",value:t.value,line:t.line,column:t.column,fileName:t.fileName},value:i,typeAnnotation:o,line:e.line,column:e.column,fileName:e.fileName}}(o);if("-"===o.value)return{type:"UnaryExpression",operator:"unary-",argument:i(),line:o.line,column:o.column,fileName:o.fileName};if("not"===o.value)return{type:"UnaryExpression",operator:"not",argument:l(),line:o.line,column:o.column,fileName:o.fileName};switch(o.value){case"require":return function(e){const t=r();if("("!==t.value)throw console.error(`Expected '(' at line ${t.line}, column ${t.column}, fileName ${t.fileName}`),new Error("Stop program.");const n=r();if(!n.value.startsWith('"'))throw console.error(`Expected string literal at line ${n.line}, column ${n.column}, fileName ${n.fileName}`),new Error("Stop program.");const a=r();if(")"!==a.value)throw console.error(`Expected ')' at line ${a.line}, column ${a.column}, fileName ${a.fileName}`),new Error("Stop program.");return{type:"RequireStatement",moduleName:n.value.slice(1,-1),line:e.line,column:e.column,fileName:e.fileName}}(o);case"function":case"fun":return c(o);case"while":return function(a){const o=l();let i=r();i||(i=e[t-1]?e[t-1]:e[e.length-1]);if("do"!==i.value)throw console.error(`Expected 'do' at line ${i.line}, column ${i.column}, fileName ${i.fileName}`),new Error("Stop program.");const s=[];for(;n()&&"end"!==n().value;)s.push(l());let c=r();c||(c=e[t-1]?e[t-1]:e[e.length-1]);if("end"!==c.value)throw console.error(`Expected 'end' at line ${c.line}, column ${c.column}, fileName ${c.fileName}`),new Error("Stop program.");return{type:"WhileStatement",condition:o,body:s,line:a.line,column:a.column,fileName:a.fileName}}(o);case"for":return function(a){let o=r();o||(o=e[t-1]?e[t-1]:e[e.length-1]);if(!/^[\p{L}_][\p{L}\p{N}_]*$/u.test(o.value))throw console.error(`Expected variable name after 'for' at line ${o.line}, column ${o.column}, fileName ${o.fileName}`),new Error("Stop program.");let i=n();if(i&&"="===i.value){r();const i=l();let s=r();if(s||(s=e[t-1]?e[t-1]:e[e.length-1]),","!==s.value)throw console.error(`Expected ',' after start value in for loop at line ${s.line}, column ${s.column}, fileName ${s.fileName}`),new Error("Stop program.");const c=l();let u={type:"Number",value:1,line:a.line,column:a.column,fileName:a.fileName};n()&&","===n().value&&(r(),u=l());let m=r();if(m||(m=e[t-1]?e[t-1]:e[e.length-1]),"do"!==m.value)throw console.error(`Expected 'do' after for loop parameters at line ${m.line}, column ${m.column}, fileName ${m.fileName}`),new Error("Stop program.");const f=[];for(;n()&&"end"!==n().value;)f.push(l());let h=r();if(h||(h=e[t-1]?e[t-1]:e[e.length-1]),"end"!==h.value)throw console.error(`Expected 'end' after for loop body at line ${h.line}, column ${h.column}, fileName ${h.fileName}`),new Error("Stop program.");return{type:"ForStatement",variable:{type:"Identifier",value:o.value,line:o.line,column:o.column,fileName:o.fileName},start:i,end:c,step:u,body:f,line:a.line,column:a.column,fileName:a.fileName}}{let i=r();if(i||(i=e[t-1]?e[t-1]:e[e.length-1]),","!==i.value)throw console.error(`Expected ',' after variable name in for loop at line ${i.line}, column ${i.column}, fileName ${o.fileName}`),new Error("Stop program.");let s=r();if(s||(s=e[t-1]?e[t-1]:e[e.length-1]),!/[a-zA-Z_][a-zA-Z0-9_]*/.test(s.value))throw console.error(`Expected variable name after ',' at line ${s.line}, column ${s.column}, fileName ${s.fileName}`),new Error("Stop program.");let c=r();if(c||(c=e[t-1]?e[t-1]:e[e.length-1]),"in"!==c.value)throw console.error(`Expected 'in' after variable name in for loop at line ${c.line}, column ${c.column}, fileName ${c.fileName}`),new Error("Stop program.");const u=l();if("FunctionCall"!==u.type)throw console.error(`Expected function call after 'in' in for loop at line ${u.line}, column ${u.column}, fileName ${u.fileName}`),new Error("Stop program.");let m=r();if(m||(m=e[t-1]?e[t-1]:e[e.length-1]),"do"!==m.value)throw console.error(`Expected 'do' after for loop parameters at line ${m.line}, column ${m.column}, fileName ${m.fileName}`),new Error("Stop program.");const f=[];for(;n()&&"end"!==n().value;)f.push(l());let h=r();if(h||(h=e[t-1]?e[t-1]:e[e.length-1]),"end"!==h.value)throw console.error(`Expected 'end' after for loop body at line ${h.line}, column ${h.column}, fileName ${h.fileName}`),new Error("Stop program.");return{type:"ForInStatement",keyVariable:{type:"Identifier",value:o.value,line:o.line,column:o.column,fileName:o.fileName},valueVariable:{type:"Identifier",value:s.value,line:s.line,column:s.column,fileName:s.fileName},iteratorCall:u,body:f,line:a.line,column:a.column,fileName:a.fileName}}}(o);case"if":return function(a){const o=l();let i=r();i||(i=e[t-1]?e[t-1]:e[e.length-1]);if("then"!==i.value)throw console.error(`Expected 'then' after 'if' condition at line ${i.line}, column ${i.column}, fileName ${i.fileName}`),new Error("Stop program.");const s=[];for(;n()&&"else"!==n().value&&"end"!==n().value;)s.push(l());let c=[];if(n()&&"else"===n().value)for(r();n()&&"end"!==n().value;)c.push(l());let u=r();u||(u=e[t-1]?e[t-1]:e[e.length-1]);if("end"!==u.value)throw console.error(`Expected 'end' after 'if' statement at line ${u.line}, column ${u.column}, fileName ${u.fileName}`),new Error("Stop program.");return{type:"IfStatement",condition:o,thenBody:s,elseBody:c,line:a.line,column:a.column,fileName:a.fileName}}(o);case"class":return function(a){const o=r();if(!/^[\p{L}_][\p{L}\p{N}_]*$/u.test(o.value))throw console.error(`Expected class name at line ${o.line}, column ${o.column}, fileName ${o.fileName}`),new Error("Stop program.");let i=null;if(n()&&"extends"===n().value){r();const e=r();if(!/^[\p{L}_][\p{L}\p{N}_]*$/u.test(e.value))throw console.error(`Expected parent class name at line ${e.line}, column ${e.column}, fileName ${e.fileName}`),new Error("Stop program.");i={type:"Identifier",value:e.value,line:e.line,column:e.column,fileName:e.fileName}}const s=[],u=[],m=[],f=[];for(;n()&&"end"!==n().value;){const e=n();let t=!1,a=!1;"static"===e.value?(t=!0,r()):"private"===e.value?(a=!0,r()):"public"===e.value&&r();const o=n();if("function"===o.value||"fun"===o.value){const e=c(r());t?f.push(e):(e.isPrivate=a,u.push(e))}else{const e=r();if(!/^[\p{L}_][\p{L}\p{N}_]*$/u.test(e.value))throw console.error(`Expected field name at line ${e.line}, column ${e.column}, fileName ${e.fileName}`),new Error("Stop program.");let o=null;n()&&"="===n().value&&(r(),o=l());const i={type:"FieldDeclaration",name:e.value,value:o,isPrivate:a,line:e.line,column:e.column,fileName:e.fileName};t?m.push(i):s.push(i)}}let h=r();h||(h=e[t-1]?e[t-1]:e[e.length-1]);if(!h||"end"!==h.value)throw console.error(`Expected 'end' at line ${h?.line}, column ${h?.column}, fileName ${h?.fileName}`),new Error("Stop program.");return{type:"ClassDefinition",name:o.value,parent:i,fields:s,methods:u,staticFields:m,staticMethods:f,line:a.line,column:a.column,fileName:a.fileName}}(o);case"break":return{type:"BreakStatement",line:o.line,column:o.column,fileName:o.fileName};case"true":return{type:"Boolean",value:!0,line:o.line,column:o.column,fileName:o.fileName};case"false":return{type:"Boolean",value:!1,line:o.line,column:o.column,fileName:o.fileName};case"nil":return{type:"Nil",value:null,line:o.line,column:o.column,fileName:o.fileName};case"switch":return function(a){const o=l(),i=[];let s=null;for(;n()&&"end"!==n().value;){const e=n();if("case"===e.value){r();const t=l(),a=r();if(":"!==a.value)throw console.error(`Expected ':' after case value at line ${a.line}, column ${a.column}, fileName ${a.fileName}`),new Error("Stop program.");const o=[];for(;n()&&"case"!==n().value&&"default"!==n().value&&"end"!==n().value;)o.push(l());i.push({test:t,body:o,line:e.line,column:e.column,fileName:e.fileName})}else if("default"===e.value){r();const t=r();if(":"!==t.value)throw console.error(`Expected ':' after default at line ${t.line}, column ${t.column}, fileName ${t.fileName}`),new Error("Stop program.");const a=[];for(;n()&&"case"!==n().value&&"default"!==n().value&&"end"!==n().value;)a.push(l());s={body:a,line:e.line,column:e.column,fileName:e.fileName}}else console.error(`Expected 'case', 'default', or 'end' at line ${e.line}, column ${e.column}, fileName ${e.fileName}`),r()}let c=r();c||(c=e[t-1]?e[t-1]:e[e.length-1]);if("end"!==c.value)throw console.error(`Expected 'end' after switch statement at line ${c.line}, column ${c.column}, fileName ${c.fileName}`),new Error("Stop program.");return{type:"SwitchStatement",discriminant:o,cases:i,defaultCase:s,line:a.line,column:a.column,fileName:a.fileName}}(o);case"try":return function(a){const o=[];for(;n()&&"catch"!==n().value&&"end"!==n().value;)o.push(l());let i=null;if(n()&&"catch"===n().value){r();const e=r();if(!/^[\p{L}_][\p{L}\p{N}_]*$/u.test(e.value))throw console.error(`Expected identifier after 'catch' at line ${e.line}, column ${e.column}, fileName ${e.fileName}`),new Error("Stop program.");const t=[];for(;n()&&"end"!==n().value;)t.push(l());i={param:{type:"Identifier",value:e.value,line:e.line,column:e.column,fileName:e.fileName},body:t}}let s=r();s||(s=e[t-1]?e[t-1]:e[e.length-1]);if("end"!==s.value)throw console.error(`Expected 'end' after try statement at line ${s.line}, column ${s.column}, fileName ${s.fileName}`),new Error("Stop program.");return{type:"TryStatement",block:o,handler:i,line:a.line,column:a.column,fileName:a.fileName}}(o);case"return":return f=o,{type:"ReturnStatement",argument:l(),line:f.line,column:f.column,fileName:f.fileName};case"...":return{type:"VarargExpression",line:o.line,column:o.column,fileName:o.fileName}}var f;if(o.value.startsWith('"')&&o.value.endsWith('"'))return{type:"String",value:o.value.slice(1,-1),line:o.line,column:o.column,fileName:o.fileName};if(/^\d+\.?\d*$/.test(o.value))return{type:"Number",value:Number(o.value),line:o.line,column:o.column,fileName:o.fileName};if(/^[\p{L}_][\p{L}\p{N}_]*$/u.test(o.value)){let e={type:"Identifier",value:o.value,line:o.line,column:o.column,fileName:o.fileName},i=null;if(n()&&":"===n().value){const e=t;i=a(!0),0===i.length&&(t=e)}for(;n()&&("."===n().value||":"===n().value||"["===n().value||"("===n().value);){const t=n();if("["===t.value){r();const n=l(),a=r();if("]"!==a.value)throw console.error(`Expected ']' at line ${a.line}, column ${a.column}, fileName ${a.fileName}`),new Error("Stop program.");e={type:"MemberExpression",object:e,property:n,computed:!0,line:t.line,column:t.column,fileName:t.fileName}}else if("."===t.value){r();const n=r();if(!/^[\p{L}_][\p{L}\p{N}_]*$/u.test(n.value))throw console.error(`Invalid identifier at line ${n.line}, column ${n.column}, fileName ${n.fileName}`),new Error("Stop program.");e={type:"MemberExpression",object:e,property:{type:"Identifier",value:n.value,line:n.line,column:n.column,fileName:n.fileName},computed:!1,line:t.line,column:t.column,fileName:t.fileName}}else if(":"===t.value){r();const a=r();if(!/^[\p{L}_][\p{L}\p{N}_]*$/u.test(a.value))throw console.error(`Invalid method name at line ${a.line}, column ${a.column}, fileName ${a.fileName}`),new Error("Stop program.");e={type:"MemberExpression",object:e,property:{type:"Identifier",value:a.value,line:a.line,column:a.column,fileName:a.fileName},computed:!1,line:t.line,column:t.column,fileName:t.fileName},n()&&"("===n().value&&(e=s(e))}else"("===t.value&&(e=u(e))}if(n()&&"++"===n().value)return r(),{type:"UpdateExpression",operator:"++",argument:e,prefix:!1,line:o.line,column:o.column,fileName:o.fileName};if(n()&&":"===n().value){r();const t=r();if(n()&&"("===n().value)return e={type:"MemberExpression",object:e,property:{type:"Identifier",value:t.value,line:t.line,column:t.column,fileName:t.fileName},computed:!1,line:o.line,column:o.column,fileName:o.fileName},{type:"FunctionMethodCall",callee:e,arguments:m(),line:o.line,column:o.column,fileName:o.fileName}}if(n()&&"="===n().value){r();return{type:"AssignmentExpression",target:e,value:l(),typeAnnotation:i||void 0,line:o.line,column:o.column,fileName:o.fileName}}return e}if("{"===o.value)return function(o){const i={type:"Table",properties:[],typeAnnotation:a(),line:o.line,column:o.column,fileName:o.fileName};let s=0,c=!1;for(;n()&&"}"!==n().value;){let a;if("["===n().value){r(),a=l();const e=r();if("]"!==e.value)throw console.error(`Expected ']' at line ${e.line}, column ${e.column}, fileName ${e.fileName}`),new Error("Stop program.");c=!0}else if(/^[\p{L}_][\p{L}\p{N}_]*$/u.test(n().value)&&"="===e[t+1]?.value)a={type:"String",value:r().value,line:n()?.line,column:n()?.column,fileName:n()?.fileName},c=!0;else{if(c)throw console.error(`Expected key definition at line ${n()?.line}, column ${n()?.column}, fileName ${n()?.fileName}`),new Error("Stop program.");a={type:"Number",value:s++,line:n()?.line,column:n()?.column,fileName:n()?.fileName}}if(n()&&"="===n().value)r();else if(c)throw console.error(`Expected '=' after key at line ${n()?.line}, column ${n()?.column}, fileName ${n()?.fileName}`),new Error("Stop program.");const o=l();if(i.properties.push({key:a,value:o,line:a.line,column:a.column,fileName:a.fileName}),","===n()?.value)r();else if("}"!==n()?.value)throw console.error(`Expected ',' or '}' at line ${n()?.line}, column ${n()?.column}, fileName ${n()?.fileName}`),new Error("Stop program.")}const u=r();if(!u||"}"!==u.value)throw console.error(`Expected '}' at line ${u?.line}, column ${u?.column}, fileName ${u?.fileName}`),new Error("Stop program.");return i}(o);throw console.error(`Unexpected token '${o.value}' at line ${o.line}, column ${o.column}, fileName ${o.fileName}`),new Error("Stop program.")}function s(a){r();const o=[];for(;n()&&")"!==n().value;)o.push(l()),n()&&","===n().value&&r();let i=r();if(i||(i=e[t-1]?e[t-1]:e[e.length-1]),!i||")"!==i.value)throw console.error(`Expected ')' at line ${i.line}, column ${i.column}, fileName ${i.fileName}`),new Error("Stop program.");const c=a.object;o.unshift(c);let m={type:"FunctionMethodCall",callee:a,arguments:o,line:a.line,column:a.column,fileName:a.fileName};for(;n()&&("."===n().value||":"===n().value||"["===n().value||"("===n().value);){const e=r();if("["===e.value){const t=l(),n=r();if("]"!==n.value)throw console.error(`Expected ']' at line ${n.line}, column ${n.column}, fileName ${n.fileName}`),new Error("Stop program.");m={type:"MemberExpression",object:m,property:t,computed:!0,line:e.line,column:e.column,fileName:e.fileName}}else if("."===e.value){const t=r();if(!/^[\p{L}_][\p{L}\p{N}_]*$/u.test(t.value))throw console.error(`Invalid identifier at line ${t.line}, column ${t.column}, fileName ${t.fileName}`),new Error("Stop program.");m={type:"MemberExpression",object:m,property:{type:"Identifier",value:t.value,line:t.line,column:t.column,fileName:t.fileName},computed:!1,line:e.line,column:e.column,fileName:e.fileName}}else if(":"===e.value){const t=r();if(!/^[\p{L}_][\p{L}\p{N}_]*$/u.test(t.value))throw console.error(`Invalid method name at line ${t.line}, column ${t.column}, fileName ${t.fileName}`),new Error("Stop program.");m={type:"MemberExpression",object:m,property:{type:"Identifier",value:t.value,line:t.line,column:t.column,fileName:t.fileName},computed:!1,line:e.line,column:e.column,fileName:e.fileName},n()&&"("===n().value&&(m=s(m))}else"("===e.value&&(m=u(m))}return m}function c(o){let i=`anon_${Math.random().toString(36).substr(2,8)}`,s=!1,c=!1;n()&&"*"===n().value&&(c=!0,r());let u=n();if(u&&/^[\p{L}_][\p{L}\p{N}_]*$/u.test(u.value)&&(i=r().value,u=n()),u&&":"===u.value){s=!0,r();i=r().value,u=n()}if(u||(u=e[t-1]||e[e.length-1]),"("!==u.value)throw console.error(`Expected '(' at line ${u.line}, column ${u.column}`),new Error("Stop program.");r();const m=[];let f=!1;for(;n()&&")"!==n().value;){const e=r();if("..."===e.value){f=!0,m.push({type:"Vararg",value:"...",line:e.line,column:e.column,fileName:e.fileName});break}const t=a();m.push({type:"Identifier",value:e.value,typeAnnotation:t,line:e.line,column:e.column,fileName:e.fileName}),n()&&","===n().value&&r()}let h=r();if(h||(h=e[t-1]?e[t-1]:e[e.length-1]),")"!==h.value)throw console.error(`Expected ')' at line ${h.line}, column ${h.column}`),new Error("Stop program.");const p=a(),d=[];for(;n()&&"end"!==n().value;)d.push(l());let y=r();if(y||(y=e[t-1]?e[t-1]:e[e.length-1]),"end"!==y.value)throw console.error(`Expected 'end' at line ${y.line}, column ${y.column}`),new Error("Stop program.");return{type:s?"FunctionMethodDefinition":"FunctionDefinition",name:i,isAsync:c,params:m,hasVararg:f,returnType:p,body:d,line:o.line,column:o.column,fileName:o.fileName}}function u(a){r();const o=[];for(;n()&&")"!==n().value;)o.push(l()),n()&&","===n().value&&r();let i=r();if(i||(i=e[t-1]?e[t-1]:e[e.length-1]),!i||")"!==i.value)throw console.error(`Expected ')' at line ${i.line}, column ${i.column}, fileName ${i.fileName}`),new Error("Stop program.");let c={type:"Identifier"===a.type&&/^[A-Z]/.test(a.value)?"ClassInstantiation":"FunctionCall",callee:a,arguments:o,line:a.line,column:a.column,fileName:a.fileName};for(;n()&&("."===n().value||":"===n().value||"["===n().value||"("===n().value);){const e=r();if("["===e.value){const t=l(),n=r();if("]"!==n.value)throw console.error(`Expected ']' at line ${n.line}, column ${n.column}, fileName ${n.fileName}`),new Error("Stop program.");c={type:"MemberExpression",object:c,property:t,computed:!0,line:e.line,column:e.column,fileName:e.fileName}}else if("."===e.value){const t=r();if(!/^[\p{L}_][\p{L}\p{N}_]*$/u.test(t.value))throw console.error(`Invalid identifier at line ${t.line}, column ${t.column}, fileName ${t.fileName}`),new Error("Stop program.");c={type:"MemberExpression",object:c,property:{type:"Identifier",value:t.value,line:t.line,column:t.column,fileName:t.fileName},computed:!1,line:e.line,column:e.column,fileName:e.fileName}}else if(":"===e.value){const t=r();if(!/^[\p{L}_][\p{L}\p{N}_]*$/u.test(t.value))throw console.error(`Invalid method name at line ${t.line}, column ${t.column}, fileName ${t.fileName}`),new Error("Stop program.");c={type:"MemberExpression",object:c,property:{type:"Identifier",value:t.value,line:t.line,column:t.column,fileName:t.fileName},computed:!1,line:e.line,column:e.column,fileName:e.fileName},n()&&"("===n().value&&(c=s(c))}else"("===e.value&&(c=u(c))}return c}function m(){r();const e=[];for(;n()&&")"!==n().value;)e.push(l()),n()&&","===n().value&&r();const t=r();if(")"!==t.value)throw console.error(`Expected ')' at line ${t.line}, column ${t.column}`),new Error("Stop program.");return e}const f=[];for(;t<e.length;){const e=l();e&&"End"!==e.type&&f.push(e)}return f}const createDom=function(){return{get:(e,t=document)=>t.querySelector(e),getAll:(e,t=document)=>Array.from(t.querySelectorAll(e)),byId:e=>document.getElementById(e),create:async(e,t={})=>{const n=document.createElement(e);return t.attrs&&Object.entries(t.attrs).forEach((([e,t])=>{n.setAttribute(e,t)})),t.text&&(n.textContent=t.text),t.html&&(n.innerHTML=t.html),t.listeners&&Object.entries(t.listeners).forEach((([e,t])=>{n.addEventListener(e,t)})),n},append:async(e,...t)=>(t.forEach((t=>e.appendChild(t))),e),remove:e=>e.parentNode.removeChild(e),addClass:async(e,...t)=>(e.classList.add(...t.flatMap((e=>e.split(" ")))),e),removeClass:async(e,...t)=>(e.classList.remove(...t.flatMap((e=>e.split(" ")))),e),css:async(e,t)=>"string"==typeof t?e.style[t]:(Object.assign(e.style,t),e),on:async(e,t,n,r)=>{const a=e=>n(e.detail||e);return e.addEventListener(t,a,r),()=>e.removeEventListener(t,a,r)},val:async(e,t)=>void 0!==t?(e.value=t,e):e.value,animate:async(e,t,n)=>{const r=e.animate(t,n);return{finished:r.finished,cancel:()=>r.cancel()}},show:async e=>{const t=e.dataset.originalDisplay||"block";return e.style.display=t,e},hide:async e=>("none"!==e.style.display&&(e.dataset.originalDisplay=getComputedStyle(e).display),e.style.display="none",e),fetch:async(e,t={})=>{try{const n=await window.fetch(e,t);return{ok:n.ok,status:n.status,json:async()=>await n.json(),text:async()=>await n.text(),blob:async()=>await n.blob()}}catch(e){return{ok:!1,error:e.message}}},trigger:async(e,t,n=null)=>{const r=new CustomEvent(t,{detail:n});return e.dispatchEvent(r),e},data:async(e,t,n)=>void 0!==n?(e.dataset[t]=n,e):e.dataset[t],delegate:async(e,t,n,r)=>{const a=t=>{const a=t.target.closest(n);a&&e.contains(a)&&r.call(a,t)};return e.addEventListener(t,a),()=>e.removeEventListener(t,a)},isVisible:async e=>e.offsetWidth>0||e.offsetHeight>0||e.getClientRects().length>0,serialize:async e=>Object.fromEntries(new FormData(e).entries()),prepend:async(e,...t)=>(t.reverse().forEach((t=>e.prepend(t))),e),before:async(e,...t)=>(t.forEach((t=>e.before(t))),e),after:async(e,...t)=>(t.forEach((t=>e.after(t))),e),toggleClass:async(e,t)=>(e.classList.toggle(t),e),hasClass:async(e,t)=>e.classList.contains(t),attr:async(e,t,n)=>void 0!==n?(e.setAttribute(t,n),e):e.getAttribute(t),replace:async(e,t)=>(e.replaceWith(t),t),clone:async(e,t=!0)=>e.cloneNode(t),children:async e=>Array.from(e.children),parent:async e=>e.parentElement,siblings:async e=>Array.from(e.parentElement.children).filter((t=>t!==e)),closest:async(e,t)=>e.closest(t),matches:async(e,t)=>e.matches(t),toggle:async e=>"none"===e.style.display?dom.show(e):dom.hide(e),scrollTo:async(e,t={})=>(e.scrollIntoView(t),e),getStyle:async(e,t)=>getComputedStyle(e)[t],debug:async e=>{const t={tag:e.tagName,id:e.id||null,classes:Array.from(e.classList),attributes:Object.fromEntries([...e.attributes].map((e=>[e.name,e.value]))),rect:e.getBoundingClientRect(),computedStyles:getComputedStyle(e)};return console.log("DOM Element Debug:",t),e},batchUpdate:async(e,t)=>{const n=document.createDocumentFragment();return t.forEach((e=>{const t=e.element||dom.create(e.tag,e.options);n.appendChild(t)})),e.appendChild(n),e},observe:async(e,t,n={attributes:!0,childList:!0,subtree:!0})=>{const r=new MutationObserver((e=>t(e)));return r.observe(e,n),()=>r.disconnect()},loadScript:async(e,t={})=>{const n=await dom.create("script",{attrs:{src:e,...t.attrs},listeners:{load:t.onload,error:t.onerror}});return document.head.appendChild(n),n},loadStyle:async(e,t={})=>{const n=await dom.create("link",{attrs:{rel:"stylesheet",href:e,...t.attrs}});return document.head.appendChild(n),n},findByText:async(e,t=document)=>{const n=new RegExp(e,"i");return dom.getAll("*",t).filter((e=>n.test(e.textContent)))},disable:async e=>(e.setAttribute("disabled","true"),e),enable:async e=>(e.removeAttribute("disabled"),e),setFocus:async e=>(e.focus(),e),clear:async e=>(e.innerHTML="",e)}},pcall=async(e,...t)=>{try{if("function"!=typeof e)return{result:null,error:"Attempt to call a non-function",isComplete:!1};return{result:await e(...t),error:null,isComplete:!0}}catch(e){return console.error("pcall caught error:",e),{result:null,error:e.message,isComplete:!1}}},assert=(e,t)=>{if(!e)throw new Error(`Assertion failed: ${t||"Condition is false"}`)},error=e=>{throw new Error(e)},xpcall=async(e,t,...n)=>{try{return{result:await e(...n),error:null,isComplete:!0}}catch(e){try{return{result:await t(e),error:e.message,isComplete:!1,handled:!0}}catch(e){return console.error("Error handler failed:",e),{result:null,error:e.message,isComplete:!1,handled:!1}}}},tonumber=(e,t=0)=>{const n=Number(e);return isNaN(n)?t:n},tostring=function(e){return String(e)},type=e=>{if(null===e)return"null";if(void 0===e)return"undefined";const t=typeof e;return"number"===t?"number":"string"===t?"string":"boolean"===t?"boolean":"function"===t?"function":"object"===t?"table":t},warn=e=>{console.warn(e)},len=async function(...e){let t=0;for(const n of e)t+=tonumber(Array.isArray(n)||"string"==typeof n?n.length:Object.keys(n).length);return t},createIterator=function(e){let t=e();return{next:()=>{if(null===t)return{done:!0};const n=t;return t=e(),{value:n,done:!1}},[Symbol.iterator]:function(){return this}}},toArray=e=>Object.entries(e).sort(((e,t)=>Number(e[0])-Number(t[0]))).map((([e,t])=>t)),ipairs=e=>{let t=e;if("table"===type(e)&&(t=toArray(e)),!Array.isArray(t)&&"string"!=typeof t)throw new Error("ipairs expects array-like table");let n=0;return createIterator((()=>n<t.length?[n,t[n++]]:null))},pairs=e=>{if(Array.isArray(e)){const t=Object.keys(e);return createIterator((()=>{if(n<t.length){const r=t[n];return n++,[Number(r),e[r]]}return null}))}const t=Object.keys(e);let n=0;return createIterator((()=>{if(n<t.length){const r=t[n];return n++,[r,e[r]]}return null}))},next=(e,t)=>{const n=Object.keys(e);let r=null===t?0:n.indexOf(t)+1;if(r<n.length){const t=n[r];return[t,e[t]]}return null},print=function(...e){console.log(...e)},createHttp=()=>({get:async e=>{const t=await fetch(e);if(!t.ok)throw new Error(`HTTP error! Status: ${t.status}`);return{body:await t.json()}},post:async(e,t)=>{const n=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!n.ok)throw new Error(`HTTP error! Status: ${n.status}`);return{body:await n.json()}}}),createJson=function(){return{encode:function(e){try{return JSON.stringify(e)}catch(e){if(e instanceof TypeError&&e.message.startsWith("cyclic object value"))throw new TypeError("JSONLib.encode: Unexpected cyclic reference detected after deep copy.  This is a bug in deepCopy().");throw e}},decode:function(e){try{return JSON.parse(e)}catch(e){throw new SyntaxError("JSONLib.decode: Недопустимый JSON: "+e.message)}},isValid:function(e){try{return JSON.parse(e),!0}catch(e){return!1}},pretty:function(e,t=2){try{const n=JSON.parse(e);return JSON.stringify(n,null,t)}catch(t){return e}},get:function(e,t,n=void 0){if("object"!=typeof e||null===e)return n;const r=t.split(".");let a=e;for(const e of r){if("object"!=typeof a||null===a||!(e in a))return n;a=a[e]}return a}}},createMath=function(){class e{constructor(...e){this.components=e}add(t){return this._checkLength(t),new e(...this.components.map(((e,n)=>e+t.components[n])))}subtract(t){return this._checkLength(t),new e(...this.components.map(((e,n)=>e-t.components[n])))}scale(t){return new e(...this.components.map((e=>e*t)))}dot(e){return this._checkLength(e),this.components.reduce(((t,n,r)=>t+n*e.components[r]),0)}cross(t){if(3!==this.components.length||3!==t.components.length)throw new Error("Cross product is only defined for 3D vectors");const[n,r,a]=this.components,[o,l,i]=t.components;return new e(r*i-a*l,a*o-n*i,n*l-r*o)}magnitude(){return Math.sqrt(this.components.reduce(((e,t)=>e+t**2),0))}normalize(){const e=this.magnitude();if(0===e)throw new Error("Cannot normalize zero vector");return this.scale(1/e)}equals(e,t=1e-6){return this.components.every(((n,r)=>Math.abs(n-e.components[r])<t))}_checkLength(e){if(this.components.length!==e.components.length)throw new Error("Vectors must have same length")}toString(){return`Vector(${this.components.join(", ")})`}}class t{constructor(e){if(!e.every((t=>t.length===e[0].length)))throw new Error("All rows must have same length");this.rows=e.map((e=>[...e])),this.rowsCount=e.length,this.colsCount=e[0].length}transpose(){const e=[];for(let t=0;t<this.colsCount;t++){e[t]=[];for(let n=0;n<this.rowsCount;n++)e[t][n]=this.rows[n][t]}return new t(e)}multiply(e){if(this.colsCount!==e.rowsCount)throw new Error("Columns count of A must match rows count of B");const n=[];for(let t=0;t<this.rowsCount;t++){n[t]=[];for(let r=0;r<e.colsCount;r++){let a=0;for(let n=0;n<this.colsCount;n++)a+=this.rows[t][n]*e.rows[n][r];n[t][r]=a}}return new t(n)}determinant(){if(!this.isSquare())throw new Error("Matrix must be square");if(1===this.rowsCount)return this.rows[0][0];if(2===this.rowsCount)return this.rows[0][0]*this.rows[1][1]-this.rows[0][1]*this.rows[1][0];let e=0;for(let t=0;t<this.colsCount;t++)e+=this.rows[0][t]*this.cofactor(0,t);return e}cofactor(e,t){return(-1)**(e+t)*this.minorMatrix(e,t).determinant()}minorMatrix(e,n){return new t(this.rows.filter(((t,n)=>n!==e)).map((e=>e.filter(((e,t)=>t!==n)))))}inverse(){const e=this.determinant();if(0===e)throw new Error("Matrix is singular");const n=[];for(let e=0;e<this.rowsCount;e++){n[e]=[];for(let t=0;t<this.colsCount;t++)n[e][t]=this.cofactor(e,t)}return new t(n).transpose().scale(1/e)}scale(e){return new t(this.rows.map((t=>t.map((t=>t*e)))))}isSquare(){return this.rowsCount===this.colsCount}equals(e,t=1e-6){return this.rows.every(((n,r)=>n.every(((n,a)=>Math.abs(n-e.rows[r][a])<t))))}toString(){return this.rows.map((e=>e.join("\t"))).join("\n")}static identity(e){const n=[];for(let t=0;t<e;t++)n[t]=new Array(e).fill(0),n[t][t]=1;return new t(n)}}const n={pi:Math.PI,huge:1/0,vec:{create:(...t)=>new e(...t),add:(e,t)=>e.add(t),sub:(e,t)=>e.subtract(t),scale:(e,t)=>e.scale(t),dot:(e,t)=>e.dot(t),cross:(e,t)=>e.cross(t),mag:e=>e.magnitude(),normalize:e=>e.normalize(),dist:(e,t)=>e.subtract(t).magnitude(),angleBetween:(e,t)=>{const n=e.dot(t);return Math.acos(n/(e.magnitude()*t.magnitude()))}},mat:{create:e=>new t(e),identity:e=>t.identity(e),transpose:e=>e.transpose(),multiply:(e,t)=>e.multiply(t),determinant:e=>e.determinant(),inverse:e=>e.inverse(),rotation2D:e=>{const n=Math.cos(e),r=Math.sin(e);return new t([[n,-r],[r,n]])},rotationX:e=>{const n=Math.cos(e),r=Math.sin(e);return new t([[1,0,0],[0,n,-r],[0,r,n]])},rotationY:e=>{const n=Math.cos(e),r=Math.sin(e);return new t([[n,0,r],[0,1,0],[-r,0,n]])},rotationZ:e=>{const n=Math.cos(e),r=Math.sin(e);return new t([[n,-r,0],[r,n,0],[0,0,1]])}},round:Math.ceil,abs:Math.abs,acos:Math.acos,asin:Math.asin,atan:Math.atan,atan2:Math.atan2,ceil:Math.ceil,cos:Math.cos,deg:e=>180*e/Math.PI,exp:Math.exp,floor:Math.floor,fmod:(e,t)=>e-Math.floor(e/t)*t,log:(e,t)=>t?Math.log(e)/Math.log(t):Math.log(e),max:(...e)=>Math.max(...e),min:(...e)=>Math.min(...e),modf:e=>{const t=Math.trunc(e);return{__multiReturn:!0,1:t,2:e-t}},rad:e=>e*Math.PI/180,sin:Math.sin,sqrt:Math.sqrt,tan:Math.tan,frexp:e=>{if(0===e)return{__multiReturn:!0,1:0,2:0};const t=Math.floor(Math.log2(Math.abs(e)))+1;return{__multiReturn:!0,1:e*Math.pow(2,-t),2:t}},ldexp:(e,t)=>e*Math.pow(2,t),_randState:1,randomseed:e=>{n._randState=e?2147483647&e:2147483647&(new Date).getTime()},random:(...e)=>{n._randState=214013*n._randState+2531011&2147483647;const t=(n._randState>>>16)/32767;if(0===e.length)return t;if(1===e.length){const n=e[0];return Math.floor(t*n)+1}if(2===e.length){const[n,r]=e;return Math.floor(t*(r-n+1))+n}throw new Error("wrong number of arguments to 'random'")},cosh:Math.cosh||function(e){return(Math.exp(e)+Math.exp(-e))/2},sinh:Math.sinh||function(e){return(Math.exp(e)-Math.exp(-e))/2},tanh:Math.tanh||function(e){return e===1/0?1:e===-1/0?-1:(Math.exp(2*e)-1)/(Math.exp(2*e)+1)},log10:e=>Math.log10(e),pow:Math.pow,ult:(e,t)=>e>>>0<t>>>0,lerp:function(e,t,n){return t+e*(n-t)},clamp:(e,t,n)=>Math.min(Math.max(e,t),n),smoothstep:(e,t,r)=>(e=n.clamp((e-t)/(r-t),0,1))*e*(3-2*e),toPolar:(e,t)=>({r:Math.sqrt(e*e+t*t),theta:Math.atan2(t,e)}),fromPolar:(e,t)=>({x:e*Math.cos(t),y:e*Math.sin(t)})};return n.randomseed(),n},createNoise=()=>{const e={perm:new Array(512),grad3:[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]],F2:.5*(Math.sqrt(3)-1),G2:(3-Math.sqrt(3))/6,F3:1/3,G3:1/6,init:function(e=0){const t=new Array(256);for(let e=0;e<256;e++)t[e]=e;let n=1664525*e+1013904223>>>0;for(let e=0;e<256;e++){n=1664525*n+1013904223>>>0;const r=n%256;[t[e],t[r]]=[t[r],t[e]]}for(let e=0;e<512;e++)this.perm[e]=t[255&e]},grad:function(e,t,n,r){const a=15&e,o=a<8?t:n,l=a<4?n:12===a||14===a?t:r;return(0==(1&a)?o:-o)+(0==(2&a)?l:-l)},fade:function(e){return e*e*e*(e*(6*e-15)+10)},lerp:function(e,t,n){return e+n*(t-e)},perlin1D:function(e,t=0){this.init(t);const n=255&Math.floor(e);e-=Math.floor(e);const r=this.fade(e),a=this.perm[n],o=this.perm[n+1];return this.lerp(this.grad(a,e,0,0),this.grad(o,e-1,0,0),r)},perlin2D:function(e,t,n=0){this.init(n);const r=255&Math.floor(e),a=255&Math.floor(t);e-=Math.floor(e),t-=Math.floor(t);const o=this.fade(e),l=this.fade(t),i=this.perm[r]+a,s=this.perm[r+1]+a;return this.lerp(this.lerp(this.grad(this.perm[i],e,t,0),this.grad(this.perm[s],e-1,t,0),o),this.lerp(this.grad(this.perm[i+1],e,t-1,0),this.grad(this.perm[s+1],e-1,t-1,0),o),l)},perlin3D:function(e,t,n,r=0){this.init(r);const a=255&Math.floor(e),o=255&Math.floor(t),l=255&Math.floor(n);e-=Math.floor(e),t-=Math.floor(t),n-=Math.floor(n);const i=this.fade(e),s=this.fade(t),c=this.fade(n),u=this.perm[a]+o,m=this.perm[u]+l,f=this.perm[u+1]+l,h=this.perm[a+1]+o,p=this.perm[h]+l,d=this.perm[h+1]+l;return this.lerp(this.lerp(this.lerp(this.grad(this.perm[m],e,t,n),this.grad(this.perm[p],e-1,t,n),i),this.lerp(this.grad(this.perm[f],e,t-1,n),this.grad(this.perm[d],e-1,t-1,n),i),s),this.lerp(this.lerp(this.grad(this.perm[m+1],e,t,n-1),this.grad(this.perm[p+1],e-1,t,n-1),i),this.lerp(this.grad(this.perm[f+1],e,t-1,n-1),this.grad(this.perm[d+1],e-1,t-1,n-1),i),s),c)},simplex2D:function(e,t){const n=this.F2,r=this.G2;let a,o,l=(e+t)*n,i=Math.floor(e+l),s=Math.floor(t+l),c=(i+s)*r,u=e-(i-c),m=t-(s-c);u>m?(a=1,o=0):(a=0,o=1);let f=u-a+r,h=m-o+r,p=u-1+2*r,d=m-1+2*r,y=255&i,v=255&s,w=.5-u*u-m*m,g=.5-f*f-h*h,N=.5-p*p-d*d;return 70*((w<0?0:Math.pow(w,4)*this.dot(this.grad3[this.perm[y+this.perm[v]]%12],u,m))+(g<0?0:Math.pow(g,4)*this.dot(this.grad3[this.perm[y+a+this.perm[v+o]]%12],f,h))+(N<0?0:Math.pow(N,4)*this.dot(this.grad3[this.perm[y+1+this.perm[v+1]]%12],p,d)))},fractalNoise:function(e,t,n=4,r=.5,a=2){let o=0,l=1,i=1,s=0;for(let c=0;c<n;c++)o+=this.perlin2D(e*l,t*l)*i,s+=i,i*=r,l*=a;return o/s},dot:function(e,t,n){return e[0]*t+e[1]*n},dot3:function(e,t,n,r){return e[0]*t+e[1]*n+e[2]*r}};return e.init(),e},createOs=function(){return(()=>{const e="undefined"!=typeof process&&process.versions?.node,t={};return{...{time:()=>Math.floor(Date.now()),date:(e,t)=>{const n=t?new Date(1e3*t):new Date,r={"%Y":n.getFullYear(),"%m":(n.getMonth()+1).toString().padStart(2,"0"),"%d":n.getDate().toString().padStart(2,"0"),"%H":n.getHours().toString().padStart(2,"0"),"%M":n.getMinutes().toString().padStart(2,"0"),"%S":n.getSeconds().toString().padStart(2,"0"),"%w":n.getDay(),"%j":Math.floor((n-new Date(n.getFullYear(),0,0))/864e5),"%c":n.toLocaleString(),"%x":n.toLocaleDateString(),"%X":n.toLocaleTimeString()};return e.replace(/%./g,(e=>r[e]||e))},difftime:(e,t)=>e-t,clock:()=>{if(e){const e=process.hrtime();return e[0]+e[1]/1e9}return 1e3*performance.now()},sleep:async(...e)=>await new Promise((t=>setTimeout(t,...e)))},...e?{execute:e=>{const{execSync:t}=require("child_process");try{return[0,t(e).toString()]}catch(e){return[e.status,e.message]}},getenv:e=>process.env[e]||null,exit:(e=0)=>process.exit(e),tmpname:()=>`${require("os").tmpdir()}/tmp_${Math.random().toString(36).substr(2)}`}:{execute:()=>[null,"execute not supported in browser"],getenv:e=>{try{return localStorage.getItem(e)}catch{return t[e]||null}},exit:()=>console.warn("exit() ignored in browser"),tmpname:()=>`tmp_${Math.random().toString(36).substr(2)}.tmp`,setenv:(e,n)=>{try{localStorage.setItem(e,n)}catch{t[e]=n}}}}})()},createString=function(){const e=function(e){return e.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&")};return{byte:(e,t=0)=>e.charCodeAt(t),char:(...e)=>String.fromCharCode(...e),dump:e=>e.toString(),find:(t,n,r=0,a=!1)=>{r=Math.max(r,0),a&&(n=e(n));const o=new RegExp(n),l=t.slice(r).match(o);return l?{0:l.index+r,1:l.index+r+l[0].length-1}:null},format:(e,...t)=>{let n=0;return e.replace(/%([%scdefgiouxXq])/g,((e,r)=>{if("%"===r)return"%";if(n>=t.length)return e;const a=t[n++];switch(r){case"s":return String(a);case"c":return String.fromCharCode(Number(a));case"d":case"i":return parseInt(a,10).toString();case"e":return Number(a).toExponential();case"f":return Number(a).toFixed(6);case"g":return Number(a).toPrecision();case"o":return parseInt(a,10).toString(8);case"u":return Math.abs(parseInt(a,10)).toString();case"x":return parseInt(a,10).toString(16);case"X":return parseInt(a,10).toString(16).toUpperCase();case"q":return`"${String(a).replace(/"/g,'\\"')}"`;default:return e}}))},gmatch:(e,t)=>{const n=new RegExp(t,"g");let r;return{next:()=>{if(r=n.exec(e),r){const e={};return r.slice(0).forEach(((t,n)=>e[n]=t)),{value:e,done:!1}}return{value:void 0,done:!0}},[Symbol.iterator](){return this}}},gsub:async(e,t,n,r=1/0)=>{let a,o,l=0,i="",s=0;for(a="string"==typeof t?new RegExp(t,"g"):t;null!==(o=a.exec(e))&&l<r;){let t;if(i+=e.substring(s,o.index),"function"==typeof n){const e={};o.slice(0).forEach(((t,n)=>e[n]=t)),t=await n(e)}else t="string"==typeof n?n.replace(/%(\d+)/g,((e,t)=>{const n=parseInt(t);return o[n]||e})):String(n);i+=t,s=o.index+o[0].length,l++,a.lastIndex===s&&s<e.length&&a.lastIndex++}return i+=e.substring(s),i},len:e=>e.length,lower:e=>e.toLowerCase(),match:(e,t,n=0)=>{const r=new RegExp(t),a=e.substring(n).match(r);if(a){const e={};return a.length>1?a.slice(1).forEach(((t,n)=>e[n]=t)):e[0]=a[0],e}return null},rep:(e,t)=>e.repeat(t),reverse:e=>e.split("").reverse().join(""),sub:(e,t,n)=>(t=t>=0?t:e.length+t,n=(n=n??e.length)>=0?n:e.length+n,e.slice(t,n+1)),upper:e=>e.toUpperCase(),split:(t,n)=>{if(!n){const e=t.trim().split(/\s+/),n={};return e.forEach(((e,t)=>n[t]=e)),n}const r=new RegExp(e(n)),a=t.split(r),o={};return a.forEach(((e,t)=>o[t]=e)),o},trim:e=>e.trim(),ltrim:e=>e.replace(/^\s+/,""),rtrim:e=>e.replace(/\s+$/,""),startsWith:(e,t)=>e.startsWith(t),endsWith:(e,t)=>e.endsWith(t),contains:(e,t)=>e.includes(t),padLeft:(e,t,n=" ")=>e.padStart(t,n),padRight:(e,t,n=" ")=>e.padEnd(t,n),capitalize:e=>e.charAt(0).toUpperCase()+e.slice(1).toLowerCase(),isEmpty:e=>0===e.length,count:(t,n,r=0,a=t.length)=>(t.slice(r,a).match(new RegExp(e(n),"g"))||[]).length,join:(e,t="")=>Object.values(e).join(t),replaceFirst:(e,t,n)=>e.replace(t,n),toBytes:e=>{const t=Array.from(e).map((e=>e.charCodeAt(0))),n={};return t.forEach(((e,t)=>n[t]=e)),n},fromBytes:e=>{const t=Object.values(e);return String.fromCharCode(...t)}}},createTable=function(){const e=t=>"object"==typeof t&&null!==t?Object.fromEntries(Object.entries(t).map((([t,n])=>[t,e(n)]))):t,t=e=>Object.entries(e).sort(((e,t)=>Number(e[0])-Number(t[0]))).map((([e,t])=>t)),n=e=>Object.fromEntries(e.map(((e,t)=>[t,e]))),r=(e,t)=>{Object.keys(e).forEach((t=>delete e[t])),t.forEach(((t,n)=>e[n]=t))};return{concat:(e,n,r,a)=>{n=n||"",r=r||0;const o=t(e);a=a||o.length-1;const l=[];for(let e=r;e<=a;e++)void 0!==o[e]&&l.push(String(o[e]));return l.join(n)},insert:(e,n,a)=>{const o=t(e);return void 0===a&&(a=n,n=o.length),o.splice(n,0,a),r(e,o),e},remove:(e,n)=>{const a=t(e);if((n=void 0===n?a.length-1:n)<0||n>=a.length)return null;const o=a.splice(n,1)[0];return r(e,a),o},sort:async(e,n)=>{const a=t(e),o=async(e,t,r)=>{if(t<r){const a=await(async(e,t,r)=>{const a=e[r];let o=t-1;for(let l=t;l<r;l++)(n?await n(e[l],a):e[l]<=a)&&(o++,[e[o],e[l]]=[e[l],e[o]]);return[e[o+1],e[r]]=[e[r],e[o+1]],o+1})(e,t,r);o(e,t,a-1),o(e,a+1,r)}};return await o(a,0,a.length-1),r(e,a),e},move:(e,n,a,o,l)=>{const i=t(e),s=t(l=l||e);n=void 0===n?0:n,a=void 0===a?i.length-1:a,o=void 0===o?0:o;const c=i.slice(n,a+1);for(let e=0;e<c.length;e++)s[o+e]=c[e];return r(l,s),l},sub:(e,r,a)=>{const o=t(e);return r=r||0,a=a||o.length,n(o.slice(r,a))},maxn:e=>Math.max(...Object.keys(e).map(Number).filter((e=>!isNaN(e)))),pack:(...e)=>n(e),unpack:(e,n,r)=>{const a=t(e);return n=n||0,r=r||a.length,a.slice(n,r)},find:(e,n,r)=>{const a=t(e);for(let e=r=r||0;e<a.length;e++)if(a[e]===n)return e;return null},filter:async(e,r)=>{const a=t(e),o=[];for(let e=0;e<a.length;e++)await r(a[e])&&o.push(a[e]);return n(o)},map:async(e,n)=>{const a=t(e),o=[];for(let e=0;e<a.length;e++)o[e]=await n(a[e],e);return r(e,o),e},forEach:async(e,n)=>{const r=t(e);for(let e=0;e<r.length;e++)await n(r[e],e)},reduce:async(e,n,r)=>{const a=t(e);let o=void 0!==r?r:a[0];for(let e=void 0!==r?0:1;e<a.length;e++)o=await n(o,a[e],e);return o},reverse:e=>{const n=t(e);return r(e,n.reverse()),e},contains:(e,n)=>t(e).includes(n),count:(e,n)=>t(e).reduce(((e,t)=>e+(t===n?1:0)),0),merge:(e,r)=>n([...t(e),...t(r)]),unique:e=>n([...new Set(t(e))]),shuffle:e=>{const n=t(e);for(let e=n.length-1;e>0;e--){const t=Math.floor(Math.random()*(e+1));[n[e],n[t]]=[n[t],n[e]]}return r(e,n),e},isEmpty:e=>0===Object.keys(e).length,clone:e,indexOf:(e,n,r)=>t(e).indexOf(n,r||0),lastIndexOf:(e,n)=>t(e).lastIndexOf(n),every:(e,n)=>t(e).every(n),some:(e,n)=>t(e).some(n)}};class ReturnSignal extends Error{constructor(e){super(),this.value=e}}const global={math:createMath(),json:createJson(),os:createOs(),string:createString(),table:createTable(),dom:createDom(),_G:{},print:print,pcall:pcall,len:len,warn:warn,assert:assert,xpcall:xpcall,type:type,tostring:tostring,tonumber:tonumber,error:error,ipairs:ipairs,pairs:pairs,next:next,console:console,setTimeout:setTimeout,setInterval:setInterval,clearInterval:clearInterval,await:async function(e,...t){return await e(...t)},awaitListener:function(e,t,...n){!async function(){const r=await e(...n);t(r)}()},loadstring:async function(e){const t="loadstring",n=(new Date).toISOString(),r=parse(tokenize(e,t)),a=new Interpreter;try{return await a.run(r,t)}catch(e){throw console.error(`Error during execution of ${t} at ${n}:`,e),e}},loadscript:async function(e){const t=(new Date).toISOString();try{if("undefined"!=typeof window){const t=new Blob([e],{type:"application/javascript"}),n=URL.createObjectURL(t),r=await import(n);return URL.revokeObjectURL(n),r.default||r}{const t=require("vm"),n=new t.Script(e),r=t.createContext(Object.create(global));return n.runInContext(r),r}}catch(e){throw console.error(`Error during execution of loadscript at ${t}:`,e),e}},setenv:function(e,t){if("function"!=typeof e)throw new Error("setenv expects a function as the first argument");if(null!==t&&"object"!=typeof t)throw new Error("setenv expects an object or null as the second argument");e.env=t||null}};"undefined"!=typeof window&&(global.window=window,global.document=document,global.localStorage=localStorage,global.requestAnimationFrame=requestAnimationFrame,global.eval=eval,"undefined"!=typeof indexedDB&&(global.indexedDB=indexedDB)),global.__global=global;const globalsEnvs=[];class Interpreter{constructor(e={},t=null){this.globalEnv={...global},globalsEnvs.push(this.globalEnv),this.env=this.createEnvironment(this.globalEnv),this.moduleCache=e,this.currentModulePath=t,this.requireJs={noise:()=>createNoise(),http:()=>({get:async e=>{const t=await fetch(e);if(!t.ok)throw new Error(`HTTP error! Status: ${t.status}`);return{body:await t.json()}},post:async(e,t)=>{const n=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!n.ok)throw new Error(`HTTP error! Status: ${n.status}`);return{body:await n.json()}}}),math:()=>createMath(),json:()=>createJson(),os:()=>createOs(),string:()=>createString(),table:()=>createTable(),dom:()=>createDom()},this.functionCache=new Map,this.classPrototypes=new Map,this.privateFields=new WeakMap,this.typeAnnotations=new Map}checkType(e,t,n){const r=type(e);if(t&&!new Set(t).has(r))throw new Error(`Type mismatch: expected ${t.join(" or ")}, got ${r} at line ${n.line}, column ${n.column}, fileName ${n.fileName}`)}createEnvironment(e){return Object.create(e||null)}resolveModulePath(e,t){if(e.startsWith(".")){const n=t||this.currentModulePath;if(!n){if("undefined"!=typeof window){return`${window.location.href.split("/").slice(0,-1).join("/")||"/"}/${e}`.replace(/\/+/g,"/")}if("undefined"!=typeof require&&require.resolve)try{return require.resolve(e)}catch(t){throw new Error(`Cannot resolve relative path '${e}' without current module path: ${t.message}`)}throw new Error("Cannot resolve relative path without current module path")}return`${n.split("/").slice(0,-1).join("/")}/${e}`.replace(/\/+/g,"/")}return e}async readFile(e){if("undefined"!=typeof window)try{const t=await fetch(e);if(!t.ok)throw new Error(`Failed to load module: ${e}. Status: ${t.status}`);return await t.text()}catch(t){throw new Error(`Failed to load module: ${e}. ${t}`)}else{if("undefined"==typeof require)throw new Error("No file reading mechanism available in this environment");try{return require("fs").readFileSync(e,"utf-8")}catch(t){throw new Error(`Failed to read file: ${e}. ${t.message}`)}}}async loadModule(e,t){if(this.requireJs[e])return await this.requireJs[e]();let n=this.resolveModulePath(e,t);if(this.moduleCache[n])return this.moduleCache[n].exports;const r=[];let a,o;n.endsWith(".js")||n.endsWith(".xylo")?r.push(n):r.push(`${n}.xylo`,n,`${n}.js`);for(const e of r)try{o=await this.readFile(e),a=e;break}catch(e){continue}if(!a){if("undefined"!=typeof require&&!e.startsWith("."))try{const t=require(e);return this.moduleCache[n]={exports:t.default||t},t.default||t}catch(t){throw new Error(`Module not found: ${e} (tried: ${r.join(", ")}) and Node.js require failed: ${t.message}`)}throw new Error(`Module not found: ${e} (tried: ${r.join(", ")})`)}if(a.endsWith(".xylo")){const e=parse(tokenize(o,a)),n=new Interpreter(this.moduleCache,this.currentModulePath||t);n.currentModulePath=a;const r={};return n.env.exports=r,await n.run(e),this.moduleCache[a]={exports:r},r}if(a.endsWith(".js"))try{if("undefined"!=typeof window){const e=await import(a);return this.moduleCache[a]={exports:e.default||e},e.default||e}{const e=require(a);return this.moduleCache[a]={exports:e.default||e},e.default||e}}catch(e){throw new Error(`JS module load error: ${e.message}`)}throw new Error(`Unsupported module type: ${a}`)}async evaluate(e){try{switch(e.type){case"LocalDeclaration":return await this.handleLocalDeclaration(e);case"AssignmentExpression":return await this.handleAssignment(e);case"FunctionDefinition":this.env[e.name]=this.createFunction(e);break;case"FunctionMethodDefinition":this.env[e.object.value][e.name]=this.createFunction(e);break;case"FunctionCall":return await this.handleFunctionCallAsync(e);case"FunctionMethodCall":return await this.handleFunctionMethodCallAsync(e);case"MemberExpression":return await this.handleMemberAccessAsync(e);case"WhileStatement":return await this.handleWhileStatementAsync(e);case"ForStatement":return await this.handleForStatementAsync(e);case"ForInStatement":return await this.handleForInStatementAsync(e);case"IfStatement":return await this.handleIfStatementAsync(e);case"BinaryExpression":return await this.evaluateBinaryExpressionAsync(e);case"UnaryExpression":return await this.evaluateUnaryExpressionAsync(e);case"UpdateExpression":return await this.handleUpdateExpressionAsync(e);case"ReturnStatement":return await this.evaluateValueAsync(e.argument);case"ClassDefinition":this.env[e.name]=this.createClass(e);break;case"ClassInstantiation":return await this.handleClassInstantiation(e);case"BreakStatement":return await this.handleBreakStatement(e);case"SwitchStatement":return await this.handleSwitchStatementAsync(e);case"TryStatement":return await this.handleTryStatementAsync(e);case"RequireStatement":return await this.loadModule(e.moduleName,this.currentModulePath);case"GlobalDeclaration":return await this.handleGlobalDeclaration(e);default:throw new Error(`Unknown node type: ${e.type} at line ${e.line}, column ${e.column}, fileName ${e.fileName}`)}}catch(t){if(!t.message.includes("line")&&void 0!==e.line&&void 0!==e.column)throw new Error(`${t.message} at line ${e.line}, column ${e.column}, fileName ${e.fileName}`);throw t}}async evaluateValueAsync(e){if(e.typeAnnotation&&this.checkType(value,e.typeAnnotation,e),"Number"===e.type||"Boolean"===e.type)return e.value;if("String"===e.type)return e.value.replaceAll("\\n","\n");if("Nil"===e.type)return null;switch(e.type){case"Identifier":if(!(e.value in this.env))throw new Error(`Undefined variable: ${e.value} at line ${e.line}, column ${e.column}, fileName ${e.fileName}`);return this.env[e.value];case"Table":return await this.createTable(e);case"MemberExpression":return await this.handleMemberAccessAsync(e);case"AssignmentExpression":return await this.handleAssignment(e);case"FunctionCall":return await this.handleFunctionCallAsync(e);case"FunctionMethodCall":return await this.handleFunctionMethodCallAsync(e);case"FunctionDefinition":return this.createFunction(e);case"ClassDefinition":return this.createClass(e);case"ClassInstantiation":return await this.handleClassInstantiation(e);case"BinaryExpression":return await this.evaluateBinaryExpressionAsync(e);case"UnaryExpression":return await this.evaluateUnaryExpressionAsync(e);case"RequireStatement":return await this.loadModule(e.moduleName,this.currentModulePath);case"VarargExpression":if(!("..."in this.env))throw new Error(`Vararg '...' used outside of vararg function at line ${e.line}, column ${e.column}, fileName ${e.fileName}`);return this.env["..."];default:throw new Error(`Unsupported value type: ${e.type} at line ${e.line}, column ${e.column}, fileName ${e.fileName}`)}}async handleClassInstantiation(e){const t=await this.evaluateValueAsync(e.callee);if(!t||"function"!=typeof t)throw new Error(`Cannot instantiate non-class '${e.callee.value}' at line ${e.line}, column ${e.column}, fileName ${e.fileName}`);const n=await Promise.all(e.arguments.map((e=>this.evaluateValueAsync(e))));return await t(...n)}async handleGlobalDeclaration(e){const t=e.identifier.value;let n=null;e.value&&(n=await this.evaluateValueAsync(e.value),this.checkType(n,e.typeAnnotation,e)),e.typeAnnotation&&this.typeAnnotations.set(t,e.typeAnnotation);for(const e in globalsEnvs)globalsEnvs[e][t]=n;return this.globalEnv.__global[t]=n,n}async handleLocalDeclaration(e){const t=e.identifier.value;let n=null;return e.value&&(n=await this.evaluateValueAsync(e.value),this.checkType(n,e.typeAnnotation,e)),e.typeAnnotation&&this.typeAnnotations.set(t,e.typeAnnotation),this.env[t]=n,n}async handleSwitchStatementAsync(e){const t=await this.evaluateValueAsync(e.discriminant);let n=!1,r=null;try{for(const a of e.cases){if(t===await this.evaluateValueAsync(a.test)){n=!0;for(const e of a.body){if("BreakStatement"==e.type)break;r=await this.evaluate(e)}break}}if(!n&&e.defaultCase)for(const t of e.defaultCase.body)r=await this.evaluate(t)}catch(e){if(e instanceof BreakSignal)return r;throw e}return r}async handleTryStatementAsync(e){try{let t=null;for(const n of e.block)t=await this.evaluate(n);return t}catch(t){if(e.handler){const n=this.createEnvironment(this.env);n[e.handler.param.value]=t.message||t;const r=new Interpreter(this.moduleCache);r.env=n,r.globalEnv=this.globalEnv,r.currentModulePath=this.currentModulePath;let a=null;for(const t of e.handler.body)a=await r.evaluate(t);return a}throw t}}async handleAssignment(e){const t=e.target,n=await this.evaluateValueAsync(e.value);if("Identifier"===t.type){const r=t.value;let a=this.env,o=null;for(;null!==a;){if(Object.prototype.hasOwnProperty.call(a,r)){o=a;break}a=Object.getPrototypeOf(a)}e.typeAnnotation&&this.typeAnnotations.set(r,e.typeAnnotation);const l=this.typeAnnotations.get(r);l&&this.checkType(n,l,e),null!==o?(o[r]=n,this.env[r]=n):(this.globalEnv[r]=n,this.env[r]=n)}else if("MemberExpression"===t.type){const r=await this.evaluateValueAsync(t.object),a=t.computed?await this.evaluateValueAsync(t.property):t.property.value;if(this.privateFields.has(r)&&this.privateFields.get(r).has(a)){if(this.env.self!==r)throw new Error(`Cannot assign to private field '${a}' at line ${e.line}, column ${e.column}, fileName ${e.fileName}`);this.privateFields.get(r).set(a,n)}else r[a]=n}return n}createFunction(e){const t=JSON.stringify({params:e.params,body:e.body});if(this.functionCache.has(t))return this.functionCache.get(t);let n=!1;const r=e.params.length,a=async(...t)=>{const o=this.env;this.env=a.env||this.createEnvironment(this.env);let l=[];if(e.hasVararg){const n=e.params.length-1;l=t.slice(n),t.length=n}if(n)for(let n=0;n<r;n++){const r=e.params[n];this.env[r.value]="Vararg"===r.type?l:t[n]}else{for(let n=0;n<r;n++){const r=e.params[n];r.typeAnnotation&&this.checkType(t[n],r.typeAnnotation,r),this.env[r.value]="Vararg"===r.type?l:t[n]}n=!0}let i=null;for(const t of e.body)if(i=await this.evaluate(t),"ReturnStatement"===t.type)return this.checkType(i,e.returnType,e),this.env=o,i;return this.checkType(i,e.returnType,e),this.env=o,i};return a.isAsync=e.isAsync,a.env=this.createEnvironment(this.env),this.functionCache.set(t,a),a}async handleFunctionMethodCallAsync(e){let t;try{t=await this.evaluateValueAsync(e.callee.property)}catch{t=await this.evaluateValueAsync(e.callee)}const n=[];for(const t of e.arguments)n.push(await this.evaluateValueAsync(t));if("function"!=typeof t&&(n.unshift(t),t=t[e.callee.property.value]),"function"!=typeof t)throw new Error(`Trying to call non-function: ${typeof t} at line ${e.line}, column ${e.column}, fileName ${e.fileName}`);return t.isAsync?void t(...n).catch((e=>{throw console.error("Async error:",e.message),new Error("Stop program.")})):await t(...n)}async handleFunctionCallAsync(e){const t=await this.evaluateValueAsync(e.callee),n=[];for(const t of e.arguments)n.push(await this.evaluateValueAsync(t));if("function"!=typeof t)throw new Error(`Trying to call non-function: ${typeof t} at line ${e.line}, column ${e.column}, fileName ${e.fileName}`);return t.isAsync?void t(...n).catch((e=>{throw console.error("Async error:",e.message),new Error("Stop program.")})):await t(...n)}async handleMemberAccessAsync(e){const t=await this.evaluateValueAsync(e.object),n=e.computed?await this.evaluateValueAsync(e.property):e.property.value;if(null==t)throw new Error(`Cannot read property '${n}' of null/undefined at line ${e.line}, column ${e.column}, fileName ${e.fileName}`);if(this.privateFields.has(t)&&this.privateFields.get(t).has(n)){if(this.env.self!==t)throw new Error(`Cannot access private field '${n}' at line ${e.line}, column ${e.column}, fileName ${e.fileName}`);return this.privateFields.get(t).get(n)}const r=t[n];return"function"==typeof r&&t!==window&&t!==document?r.bind(t):r}async createTable(e){const t={};for(const n of e.properties){const r=await this.evaluateValueAsync(n.key),a=await this.evaluateValueAsync(n.value);e.typeAnnotation&&this.checkType(a,e.typeAnnotation,e),t[r]=a}return t}async handleForStatementAsync(e){const t=e.variable.value,n=await this.evaluateValueAsync(e.start),r=await this.evaluateValueAsync(e.end),a=await this.evaluateValueAsync(e.step);if(this.env[t]=n,a>0)for(;this.env[t]<=r;){for(const t of e.body){if(await this.evaluate(t)===Symbol.for("break"))return}this.env[t]+=a}else for(;this.env[t]>=r;){for(const t of e.body){if(await this.evaluate(t)===Symbol.for("break"))return}this.env[t]+=a}}async handleWhileStatementAsync(e){for(;this.convertToBoolean(await this.evaluateValueAsync(e.condition));)for(const t of e.body){if(await this.evaluate(t)===Symbol.for("break"))return}}async handleForInStatementAsync(e){const t=e.keyVariable.value,n=e.valueVariable.value,r=e.iteratorCall,a=await this.evaluateValueAsync(r.callee),o=await this.evaluateValueAsync(r.arguments[0]),l=await a(o);let i=await l.next();for(;!i.done;){const[r,a]=i.value;this.env[t]=r,this.env[n]=a;for(const t of e.body){if(await this.evaluate(t)===Symbol.for("break"))return}i=await l.next()}}async handleBreakStatement(){return Symbol.for("break")}async handleIfStatementAsync(e){if(this.convertToBoolean(await this.evaluateValueAsync(e.condition)))for(const t of e.thenBody){const e=await this.evaluate(t);if(e===Symbol.for("break"))return e}else for(const t of e.elseBody){const e=await this.evaluate(t);if(e===Symbol.for("break"))return e}return null}async evaluateBinaryExpressionAsync(e){const t=await this.evaluateValueAsync(e.left),n=await this.evaluateValueAsync(e.right);switch(e.operator){case"+":return t+n;case"-":return t-n;case"*":return t*n;case"/":return t/n;case"==":return t===n;case"..":return String(t)+String(n);case"and":return this.convertToBoolean(t)?n:t;case"or":return this.convertToBoolean(t)?t:n;case"<":return t<n;case"<=":return t<=n;case">":return t>n;case">=":return t>=n;case"~=":case"!=":return t!=n;case"%":return t%n;case"^":return Math.pow(t,n);case"&&":return this.convertToBoolean(t)&&this.convertToBoolean(n);case"||":return this.convertToBoolean(t)||this.convertToBoolean(n)}throw new Error(`Unknown operator: ${e.operator}`)}async evaluateUnaryExpressionAsync(e){const t=await this.evaluateValueAsync(e.argument);switch(e.operator){case"unary-":if("number"!=typeof t)throw new Error("Unary '-' cannot be applied to type "+typeof t);return-t;case"not":return!this.convertToBoolean(t);default:throw new Error(`Unknown unary operator: ${e.operator}`)}}convertToBoolean(e){return"boolean"==typeof e?e:null!=e&&("number"==typeof e?0!==e:"string"!=typeof e||""!==e)}createClass(e){const t=this.createEnvironment(this.env),n={};for(const n of e.staticFields)t[n.name]=n.value?this.evaluateValueAsync(n.value):null;for(const n of e.staticMethods)t[n.name]=this.createFunction(n);for(const t of e.fields)t.isPrivate||(n[t.name]=t.value?this.evaluateValueAsync(t.value):null);for(const t of e.methods)n[t.name]=this.createFunction(t);if(e.parent){const t=this.env[e.parent.value];if(!t||!t.prototype)throw new Error(`Parent class '${e.parent.value}' not found at line ${e.line}, column ${e.column}, fileName ${e.fileName}`);Object.setPrototypeOf(n,t.prototype)}const r=n.init||(async e=>e),a=async(...t)=>{const a=Object.create(n),o=new Map;this.privateFields.set(a,o);for(const t of e.fields)t.isPrivate&&o.set(t.name,t.value?await this.evaluateValueAsync(t.value):null);const l=this.createEnvironment(this.env);l.self=a;for(const e in n)"function"==typeof n[e]&&(n[e].env=l);return await r.call(a,a,...t),a};a.prototype=n;for(const[e,n]of Object.entries(t))a[e]=n;return this.classPrototypes.set(e.name,n),a}async handleUpdateExpressionAsync(e){const t=e.argument;if("Identifier"===t.type){const n=t.value;if(!(n in this.env))throw new Error(`Undefined variable '${e.value}' at line ${e.line}, column ${e.column}, fileName ${e.fileName}`);const r=this.env[n];if("number"!=typeof r)throw new Error(`Increment/decrement operator can only be applied to numbers at line ${e.line}, column ${e.column}, fileName ${e.fileName}`);const a=r+("++"===e.operator?1:-1);let o=this.env,l=null;for(;null!==o;){if(Object.prototype.hasOwnProperty.call(o,n)){l=o;break}o=Object.getPrototypeOf(o)}return null!==l?(l[n]=a,this.env[n]=a):this.globalEnv[n]=a,e.prefix?a:r}if("MemberExpression"===t.type){const n=await this.evaluateValueAsync(t.object),r=await this.evaluateValueAsync(t.property);if("object"!=typeof n||null===n)throw new Error(`Cannot read property '${r}' of non-object at line ${e.line}, column ${e.column}, fileName ${e.fileName}`);if("number"!=typeof n[r])throw new Error(`Increment/decrement operator can only be applied to numbers at line ${e.line}, column ${e.column}, fileName ${e.fileName}`);const a=n[r],o=a+("++"===e.operator?1:-1);return n[r]=o,e.prefix?o:a}throw new Error(`Invalid argument for update expression at line ${e.line}, column ${e.column}, fileName ${e.fileName}`)}async run(e,t){let n=null;try{for(const t of e)n=await this.evaluate(t)}catch(e){if(e instanceof ReturnSignal)return e.value;throw e}return n}}let interpreter;function runXylo(e,t){const n="main.xylo",r=(new Date).toISOString();let a;a="undefined"!=typeof window?window.location.href.split("/").slice(0,-1).join("/")||"/":"undefined"!=typeof __dirname?__dirname:"";const o=parse(tokenize(e,n));interpreter=new Interpreter,interpreter.currentModulePath=t||a;try{return interpreter.run(o,n)}catch(e){throw console.error(`Error during execution of ${n} at ${r}:`,e),e}}export{runXylo};